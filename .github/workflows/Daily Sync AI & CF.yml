name: Daily Sync All

on:
  schedule:
    # æ¯å¤© UTC 20:00 (é¦™æ¸¯æ™‚é–“ 04:00) åŸ·è¡Œ
    - cron: '0 20 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•åŸ·è¡Œ
  push:
    paths:
      - '**.py' # ç•¶ Python è…³æœ¬ä¿®æ”¹æ™‚è‡ªå‹•æ¸¬è©¦é‹è¡Œ

jobs:
  sync-all:
    runs-on: ubuntu-latest
    permissions:
      contents: write # çµ¦äºˆå¯«å…¥æ¬Šé™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      # --- 1. å…±ç”¨å‰ç½®æº–å‚™ ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # ========================================================
      # ä»»å‹™ 1: CF-IPs æ›´æ–° (å„ªå…ˆåŸ·è¡Œ)
      # ========================================================
      - name: "[CF] ä¸‹è¼‰ CF-IPs.txt"
        run: |
          # ä¸‹è¼‰ fast-ips.txt ä¸¦å„²å­˜ç‚º CF-IPs.txt
          # ä½¿ç”¨æ‚¨æŒ‡å®šçš„å¸¶ Token çš„ç¶²å€
          wget -O CF-IPs.txt "https://ip.swoi.qzz.io/fast-ips.txt?token=B7suc8L5IpwkcMwr6ccPoXFkITeDcVb5&session=rQa1BKAeYxR0OH5uRrzzxgcvsZbUdk95"
          
          if [ ! -f CF-IPs.txt ]; then
            echo "Download failed!"
            exit 1
          fi

      - name: "[CF] æäº¤è®Šæ›´ (Commit)"
        run: |
          git add CF-IPs.txt
          
          if git diff --staged --quiet; then
            echo "No CF-IPs changes detected."
          else
            current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ CF-IPs.txt (ğŸ“… $current_time)"
            echo "CF-IPs committed."
          fi

      # ========================================================
      # ä»»å‹™ 2: AI è¦å‰‡æ›´æ–° & ç·¨è­¯
      # ========================================================
      - name: "[AI] å®‰è£ Python ä¾è³´"
        run: |
          python -m pip install --upgrade pip
          pip install requests PyYAML

      - name: "[AI] å®‰è£ç·¨è­¯å·¥å…· (Mihomo & Sing-box)"
        run: |
          echo "=== æ­£åœ¨å®‰è£æœ€æ–°ç‰ˆå·¥å…· ==="
          
          # 1. å®‰è£ Mihomo (Clash Meta)
          echo "Fetching Mihomo..."
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | \
            jq -r '.assets[] | select(.name | contains("linux-amd64") and (contains("compatible")|not) and contains(".gz")) | .browser_download_url' | head -n 1)
          
          if [ -z "$MIHOMO_URL" ]; then echo "Failed to find Mihomo URL"; exit 1; fi
          
          wget -q -O mihomo.gz "$MIHOMO_URL"
          gzip -d mihomo.gz
          sudo mv mihomo /usr/local/bin/
          sudo chmod +x /usr/local/bin/mihomo
          
          # 2. å®‰è£ Sing-box
          echo "Fetching Sing-box..."
          SINGBOX_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | \
            jq -r '.assets[] | select(.name | contains("linux-amd64") and contains("tar.gz")) | .browser_download_url' | head -n 1)
            
          if [ -z "$SINGBOX_URL" ]; then echo "Failed to find Sing-box URL"; exit 1; fi
          
          wget -q -O sing-box.tar.gz "$SINGBOX_URL"
          tar -zxf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          rm -rf sing-box.tar.gz sing-box-*
          
          # é©—è­‰å®‰è£
          mihomo -v
          sing-box version

      - name: "[AI] åŸ·è¡Œ Python è…³æœ¬ & å¼·åˆ¶ç·¨è­¯"
        run: |
          # 1. åŸ·è¡Œ Python ç”Ÿæˆè¦å‰‡æ–‡ä»¶ (.list, .json, .conf)
          echo "Running geosite_ai_hk.py..."
          python geosite_ai_hk.py || echo "Warning: geosite_ai_hk.py failed"
          
          echo "Running Shadowrocket_rules.py..."
          python Shadowrocket_rules.py || echo "Warning: Shadowrocket_rules.py failed"
          
          # ------------------------------------------------------------------
          # 2. åˆªé™¤èˆŠçš„äºŒé€²ä½æª”æ¡ˆ (å¼·åˆ¶é‡æ–°ç·¨è­¯)
          # ------------------------------------------------------------------
          echo "Deleting old binary files..."
          rm -f geosite_ai_hk_proxy.mrs geosite_ai_hk_proxy.srs

          # 3. ç·¨è­¯æ–°æª”æ¡ˆ
          echo "Compiling MRS (for Mihomo)..."
          if [ -f "geosite_ai_hk_proxy.list" ]; then
            mihomo convert-ruleset domain text geosite_ai_hk_proxy.list geosite_ai_hk_proxy.mrs
          else
            echo "Error: geosite_ai_hk_proxy.list not found!"
          fi

          echo "Compiling SRS (for Sing-box)..."
          if [ -f "geosite_ai_hk_proxy.json" ]; then
             sing-box rule-set compile --output geosite_ai_hk_proxy.srs geosite_ai_hk_proxy.json
          else
            echo "Error: geosite_ai_hk_proxy.json not found!"
          fi
          
          # 4. é¡¯ç¤ºçµæœ (åœ¨ Log ä¸­ç¢ºèªæª”æ¡ˆæ˜¯å¦ç”Ÿæˆ)
          ls -lh geosite_ai_hk_proxy.* ai_ad.conf || true

      - name: "[AI] æäº¤è®Šæ›´ (Commit)"
        run: |
          # --- ä½¿ç”¨ git add . ---
          # é€™æœƒè‡ªå‹•å°‡ ai_ad.conf, .list, .json, .mrs, .srs å…¨éƒ¨åŠ å…¥
          git add .
          
          if git diff --staged --quiet; then
            echo "No AI rules changes detected."
          else
            current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ AI è¦å‰‡ (ğŸ“… $current_time)"
            echo "AI Rules committed."
          fi

      # ========================================================
      # æœ€çµ‚æ¨é€
      # ========================================================
      - name: Push All Changes
        run: |
          git push
