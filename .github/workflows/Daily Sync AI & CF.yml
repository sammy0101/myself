name: Daily Sync All

on:
  schedule:
    # æ¯å¤© UTC 20:00 (é¦™æ¸¯æ™‚é–“ 04:00) åŸ·è¡Œ
    - cron: '0 20 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•åŸ·è¡Œ

jobs:
  sync-all:
    runs-on: ubuntu-latest
    permissions:
      contents: write # çµ¦äºˆå¯«å…¥æ¬Šé™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      # --- 1. å…±ç”¨å‰ç½®æº–å‚™ ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # ========================================================
      # ä»»å‹™ 1: CF-CIDR æ›´æ–°
      # ========================================================
      - name: "[CF] ä¸‹è¼‰ CF-CIDR.txt"
        run: |
          wget -O CF-CIDR.txt https://github.com/cmliu/ACL4SSR/raw/refs/heads/main/CloudflareCIDR.txt
          
          if [ ! -f CF-CIDR.txt ]; then
            echo "Download failed!"
            exit 1
          fi

      - name: "[CF] æäº¤è®Šæ›´ (Commit)"
        run: |
          git add CF-CIDR.txt
          if git diff --staged --quiet; then
            echo "No CF-CIDR changes detected."
          else
            current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ CF-CIDR.txt (ğŸ“… $current_time)"
            echo "CF-CIDR committed."
          fi

      # ========================================================
      # ä»»å‹™ 2: AI è¦å‰‡æ›´æ–° & ç·¨è­¯
      # ========================================================
      - name: "[AI] å®‰è£ä¾è³´"
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz PyYAML

      # é‡é»ä¿®æ”¹ï¼šåœ¨è·‘ Python è…³æœ¬å‰ï¼Œå…ˆå®‰è£å¥½ Sing-box å’Œ Mihomo åˆ°ç³»çµ±è·¯å¾‘
      - name: "[AI] å®‰è£ç·¨è­¯å·¥å…· (Mihomo & Sing-box)"
        run: |
          echo "=== æ­£åœ¨å®‰è£æœ€æ–°ç‰ˆå·¥å…· ==="
          
          # 1. å®‰è£ Mihomo
          echo "Fetching Mihomo..."
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | \
            jq -r '.assets[] | select(.name | contains("linux-amd64") and (contains("compatible")|not) and contains(".gz")) | .browser_download_url' | head -n 1)
          wget -q -O mihomo.gz "$MIHOMO_URL"
          gzip -d mihomo.gz
          sudo mv mihomo /usr/local/bin/
          sudo chmod +x /usr/local/bin/mihomo
          
          # 2. å®‰è£ Sing-box
          echo "Fetching Sing-box..."
          SINGBOX_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | \
            jq -r '.assets[] | select(.name | contains("linux-amd64") and contains("tar.gz")) | .browser_download_url' | head -n 1)
          wget -q -O sing-box.tar.gz "$SINGBOX_URL"
          tar -zxf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/
          sudo chmod +x /usr/local/bin/sing-box
          rm -rf sing-box.tar.gz sing-box-*
          
          # é©—è­‰
          mihomo -v
          sing-box version

      - name: "[AI] åŸ·è¡Œ Python è…³æœ¬ & å¼·åˆ¶ç·¨è­¯"
        run: |
          # 1. åŸ·è¡Œ Python ç”Ÿæˆ .json å’Œ .list
          echo "Running Python scripts..."
          python geosite_ai_hk.py
          python Shadowrocket_rules.py
          
          # 2. å¼·åˆ¶åŸ·è¡Œç·¨è­¯æŒ‡ä»¤ (ç¢ºä¿ .mrs å’Œ .srs ä¸€å®šè¢«æ›´æ–°)
          # å³ä½¿ Python è…³æœ¬è£¡æœ‰å¯«ç·¨è­¯æŒ‡ä»¤ï¼Œé€™è£¡å†è·‘ä¸€æ¬¡ä¹Ÿä¸æœƒå ±éŒ¯ï¼Œç¢ºä¿è¬ç„¡ä¸€å¤±
          
          echo "Compiling MRS..."
          if [ -f "geosite_ai_hk_proxy.list" ]; then
            # Mihomo è½‰æ›è¦å‰‡
            mihomo convert-ruleset domain text geosite_ai_hk_proxy.list geosite_ai_hk_proxy.mrs
          fi

          echo "Compiling SRS..."
          if [ -f "geosite_ai_hk_proxy.json" ]; then
             # Sing-box ç·¨è­¯è¦å‰‡
             sing-box rule-set compile --output geosite_ai_hk_proxy.srs geosite_ai_hk_proxy.json
          fi

      - name: "[AI] æäº¤è®Šæ›´ (Commit)"
        run: |
          # æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½• AI ç›¸é—œæ–‡ä»¶è®Šæ›´
          git add geosite_ai_hk_proxy.* Shadowrocket_rules.list
          
          if git diff --staged --quiet; then
            echo "No AI rules changes detected."
          else
            current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ AI è¦å‰‡ (ğŸ“… $current_time)"
            echo "AI Rules committed."
          fi

      # ========================================================
      # æœ€çµ‚æ¨é€
      # ========================================================
      - name: Push All Changes
        run: |
          git push
