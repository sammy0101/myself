name: Daily Sync All (CF First)

on:
  schedule:
    # æ¯å¤© UTC 20:00 (é¦™æ¸¯æ™‚é–“ 04:00) åŸ·è¡Œ
    - cron: '0 20 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•åŸ·è¡Œ

jobs:
  sync-all:
    runs-on: ubuntu-latest
    permissions:
      contents: write # çµ¦äºˆå¯«å…¥æ¬Šé™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      # --- 1. å…±ç”¨å‰ç½®æº–å‚™ ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # ========================================================
      # ä»»å‹™ 1: CF-CIDR æ›´æ–° (å„ªå…ˆåŸ·è¡Œ)
      # ========================================================
      - name: "[CF] ä¸‹è¼‰ CF-CIDR.txt"  # å·²ä¿®å¾©ï¼šåŠ ä¸Šé›™å¼•è™Ÿ
        run: |
          wget -O CF-CIDR.txt https://github.com/cmliu/ACL4SSR/raw/refs/heads/main/CloudflareCIDR.txt
          
          if [ ! -f CF-CIDR.txt ]; then
            echo "Download failed!"
            exit 1
          fi

      - name: "[CF] æäº¤è®Šæ›´ (Commit)"  # å·²ä¿®å¾©ï¼šåŠ ä¸Šé›™å¼•è™Ÿ
        run: |
          # åŠ å…¥æš«å­˜å€
          git add CF-CIDR.txt
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --staged --quiet; then
            echo "No CF-CIDR changes detected."
          else
            # ç²å–é¦™æ¸¯æ™‚é–“
            current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
            # æäº¤
            git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ CF-CIDR.txt (ğŸ“… $current_time)"
            echo "CF-CIDR committed."
          fi

      # ========================================================
      # ä»»å‹™ 2: AI è¦å‰‡æ›´æ–° & ç·¨è­¯ (å¾ŒåŸ·è¡Œ)
      # ========================================================
      - name: "[AI] å®‰è£ä¾è³´"  # å·²ä¿®å¾©ï¼šåŠ ä¸Šé›™å¼•è™Ÿ
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz PyYAML

      - name: "[AI] åŸ·è¡Œ Python æ›´æ–°è…³æœ¬"  # å·²ä¿®å¾©ï¼šåŠ ä¸Šé›™å¼•è™Ÿ
        run: |
          echo "Running geosite_ai_hk.py..."
          python geosite_ai_hk.py || echo "geosite_ai_hk.py failed"
          
          echo "Running Shadowrocket_rules.py..."
          python Shadowrocket_rules.py || echo "Shadowrocket_rules.py failed"

      - name: "[AI] æª¢æŸ¥è¦å‰‡è®Šæ›´"  # å·²ä¿®å¾©ï¼šåŠ ä¸Šé›™å¼•è™Ÿ
        id: check_ai_changes
        run: |
          # æ­¤æ™‚ CF-CIDR å·²ç¶“è™•ç†å®Œç•¢(å·²commitæˆ–ç„¡è®Šæ›´)ï¼Œgit status åªæœƒé¡¯ç¤º AI è…³æœ¬é€ æˆçš„è®Šæ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "AI rules changed."
            echo "ai_changed=true" >> $GITHUB_OUTPUT
          else
            echo "No AI rule changes."
            echo "ai_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: "[AI] ä¸‹è¼‰ç·¨è­¯å·¥å…· & ç·¨è­¯è¦å‰‡"  # å·²ä¿®å¾©ï¼šåŠ ä¸Šé›™å¼•è™Ÿ
        if: steps.check_ai_changes.outputs.ai_changed == 'true'
        run: |
          echo "ä¸‹è¼‰ç·¨è­¯å·¥å…·..."
          # ä¸‹è¼‰ Mihomo
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep "browser_download_url" | grep "linux-amd64" | grep ".gz" | grep -v "compatible" | head -n 1 | cut -d '"' -f 4)
          wget -O mihomo.gz "$MIHOMO_URL" && gunzip mihomo.gz && chmod +x mihomo
          
          # ä¸‹è¼‰ Sing-box
          SINGBOX_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep "browser_download_url" | grep "linux-amd64.tar.gz" | head -n 1 | cut -d '"' -f 4)
          wget -O sing-box.tar.gz "$SINGBOX_URL" && tar -xzf sing-box.tar.gz && mv sing-box-*/sing-box . && chmod +x sing-box

          echo "ç·¨è­¯ MRS..."
          if [ -f "geosite_ai_hk_proxy.list" ]; then
            touch config.yaml
            timeout 60s ./mihomo convert-ruleset domain text geosite_ai_hk_proxy.list geosite_ai_hk_proxy.mrs
            rm config.yaml
          fi

          echo "ç·¨è­¯ SRS..."
          if [ -f "geosite_ai_hk_proxy.json" ]; then
             ./sing-box rule-set compile --output geosite_ai_hk_proxy.srs geosite_ai_hk_proxy.json
          fi

          # æ¸…ç†å·¥å…·
          rm -rf mihomo sing-box sing-box.tar.gz sing-box-* config.yaml

      - name: "[AI] æäº¤è®Šæ›´ (Commit)"  # å·²ä¿®å¾©ï¼šåŠ ä¸Šé›™å¼•è™Ÿ
        if: steps.check_ai_changes.outputs.ai_changed == 'true'
        run: |
          current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
          
          # å°‡æ‰€æœ‰å‰©é¤˜è®Šæ›´(AIç›¸é—œ)åŠ å…¥
          git add .
          git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ AI è¦å‰‡ (ğŸ“… $current_time)"
          echo "AI Rules committed."

      # ========================================================
      # æœ€çµ‚æ¨é€
      # ========================================================
      - name: Push All Changes
        run: |
          # ä¸€æ¬¡æ€§æ¨é€æ‰€æœ‰ Commit
          git push
