name: Daily Sync All

on:
  schedule:
    # æ¯å¤© UTC 20:00 (é¦™æ¸¯æ™‚é–“ 04:00) åŸ·è¡Œ
    - cron: '0 20 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•åŸ·è¡Œ
  push:
    paths:
      - '**.py' # ç•¶ Python è…³æœ¬ä¿®æ”¹æ™‚è‡ªå‹•æ¸¬è©¦é‹è¡Œ

jobs:
  sync-all:
    runs-on: ubuntu-latest
    permissions:
      contents: write # çµ¦äºˆå¯«å…¥æ¬Šé™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      # --- 1. å…±ç”¨å‰ç½®æº–å‚™ ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # ========================================================
      # ä»»å‹™ 1: CF-IPs æ›´æ–° (ç¨ç«‹æª¢æŸ¥)
      # ========================================================
      - name: "[CF] ä¸‹è¼‰ CF-IPs.txt"
        run: |
          # ä¸‹è¼‰ä¸¦ç›´æ¥è¦†è“‹èˆŠæª”æ¡ˆ
          wget -O CF-IPs.txt "https://ip.swoi.qzz.io/fast-ips.txt?token=B7suc8L5IpwkcMwr6ccPoXFkITeDcVb5"
          
          if [ ! -f CF-IPs.txt ]; then
            echo "Download failed!"
            exit 1
          fi

      - name: "[CF] æª¢æŸ¥è®Šæ›´ & æäº¤"
        run: |
          git add CF-IPs.txt
          
          # åªæœ‰ç•¶å…§å®¹çœŸçš„è®Šäº†ï¼Œæ‰æäº¤
          if git diff --staged --quiet; then
            echo "âœ… CF-IPs.txt å…§å®¹ç„¡è®ŠåŒ–ï¼Œè·³éæäº¤ã€‚"
          else
            current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ CF-IPs.txt (ğŸ“… $current_time)"
            echo "ğŸš€ CF-IPs å·²æ›´æ–°ä¸¦æäº¤ã€‚"
          fi

      # ========================================================
      # ä»»å‹™ 2: AI è¦å‰‡æ›´æ–° & ç·¨è­¯ (ç¨ç«‹æª¢æŸ¥)
      # ========================================================
      - name: "[AI] å®‰è£ä¾è³´ & ç·¨è­¯å·¥å…·"
        run: |
          # 1. Python ä¾è³´
          pip install requests PyYAML
          
          # 2. ä¸‹è¼‰ Mihomo
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.assets[] | select(.name | contains("linux-amd64") and (contains("compatible")|not) and contains(".gz")) | .browser_download_url' | head -n 1)
          wget -q -O mihomo.gz "$MIHOMO_URL" && gzip -d mihomo.gz
          sudo mv mihomo /usr/local/bin/ && sudo chmod +x /usr/local/bin/mihomo
          
          # 3. ä¸‹è¼‰ Sing-box
          SINGBOX_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r '.assets[] | select(.name | contains("linux-amd64") and contains("tar.gz")) | .browser_download_url' | head -n 1)
          wget -q -O sing-box.tar.gz "$SINGBOX_URL" && tar -zxf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/ && sudo chmod +x /usr/local/bin/sing-box
          rm -rf sing-box.tar.gz sing-box-*

      - name: "[AI] åŸ·è¡Œè…³æœ¬ & ç·¨è­¯è¦å‰‡"
        run: |
          echo ">>> 1. åŸ·è¡Œ Python è…³æœ¬ (ç”Ÿæˆ List/Json/Conf) <<<"
          # å¦‚æœè…³æœ¬å…§çš„ smart_write ç™¼ç¾å…§å®¹æ²’è®Šï¼Œå°±ä¸æœƒæ›´æ–°æª”æ¡ˆæ™‚é–“
          python geosite_ai_hk.py || echo "Warning: geosite script failed"
          python Shadowrocket_rules.py || echo "Warning: shadowrocket script failed"
          
          echo ">>> 2. åŸ·è¡Œç·¨è­¯æŒ‡ä»¤ (è¦†è“‹æ¨¡å¼) <<<"
          # Mihomo: List -> MRS
          if [ -f "geosite_ai_hk_proxy.list" ]; then
            mihomo convert-ruleset domain text geosite_ai_hk_proxy.list geosite_ai_hk_proxy.mrs
          fi

          # Sing-box: Json -> SRS
          if [ -f "geosite_ai_hk_proxy.json" ]; then
             sing-box rule-set compile --output geosite_ai_hk_proxy.srs geosite_ai_hk_proxy.json
          fi

      - name: "[AI] æª¢æŸ¥è®Šæ›´ & æäº¤"
        run: |
          # å°‡æ‰€æœ‰è®Šæ›´åŠ å…¥æš«å­˜å€ (åŒ…å« .conf, .list, .json, .mrs, .srs)
          git add .
          
          # Git æœƒè‡ªå‹•æ¯”å° Hash å€¼
          # å¦‚æœç·¨è­¯å‡ºä¾†çš„ .mrs è·Ÿæ˜¨å¤©çš„äºŒé€²ä½å…§å®¹ä¸€æ¨¡ä¸€æ¨£ï¼ŒGit æœƒåˆ¤å®š "ç„¡è®Šæ›´"
          if git diff --staged --quiet; then
            echo "âœ… AI è¦å‰‡ (åŒ…å« .mrs/.srs) å…§å®¹å®Œå…¨ä¸€è‡´ï¼Œç„¡éœ€æ›´æ–°ã€‚"
          else
            current_time=$(TZ='Asia/Hong_Kong' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ AI è¦å‰‡ (ğŸ“… $current_time)"
            echo "ğŸš€ AI è¦å‰‡å·²æ›´æ–°ä¸¦æäº¤ã€‚"
          fi

      # ========================================================
      # æœ€çµ‚æ¨é€ (å¦‚æœä¸Šé¢æœ‰ä»»ä½•ä¸€å€‹ä»»å‹™ç”¢ç”Ÿäº† Commit)
      # ========================================================
      - name: Push All Changes
        run: |
          git push
