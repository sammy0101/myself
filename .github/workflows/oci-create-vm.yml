name: '[Scheduled] Create OCI A1 Flex VM'

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'è™›æ“¬æ©Ÿå™¨çš„åç¨±'
        required: true
        default: 'a1-flex-vm'
        type: string

env:
  OCI_REGION: ${{ secrets.OCI_REGION }}
  OCI_AVAILABILITY_DOMAIN: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}
  OCI_COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
  OCI_SUBNET_ID: ${{ secrets.OCI_SUBNET_ID }}
  OCI_IMAGE_OCID: ${{ secrets.OCI_IMAGE_OCID }}
  VM_SHAPE: 'VM.Standard.A1.Flex'
  OCPU_COUNT: 4
  MEMORY_IN_GB: 24

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    timeout-minutes: 30 # <--- å„ªåŒ–é» 1ï¼šé˜²æ­¢ä»»å‹™å¡æ­»ï¼Œæœ€é•·é‹è¡Œ 30 åˆ†é˜
    outputs:
      time: ${{ steps.get-current-time.outputs.time }}
      vm_exists: ${{ steps.check-vm-exists.outputs.exists }}
      checked_vm_name: ${{ steps.determine-vm-name.outputs.vm_name }}
      creation_status: ${{ steps.create-vm-script.outputs.success }}
      attempt_count: ${{ steps.create-vm-script.outputs.attempt_count }}
      error_message: ${{ steps.create-vm-script.outputs.error_message }}
      vm_name: ${{ steps.create-vm-script.outputs.vm_name }}
      public_ip: ${{ steps.get-ip.outputs.public_ip }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ç²å–ç•¶å‰æ™‚é–“
        id: get-current-time
        run: echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      # <--- å„ªåŒ–é» 2ï¼šä½¿ç”¨ setup-python ä¾†åŠ é€Ÿå®‰è£ä¸¦ç·©å­˜ä¾è³´
      - name: è¨­ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # å•Ÿç”¨ç·©å­˜ï¼ŒåŠ å¿«é‹è¡Œé€Ÿåº¦

      - name: å®‰è£èˆ‡é…ç½® OCI CLI
        run: |
          pip install oci-cli
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ env.OCI_REGION }}
          EOF
          echo "${{ secrets.OCI_API_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: æ±ºå®š VM åç¨±
        id: determine-vm-name
        run: |
          VM_NAME=""
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VM_NAME="${{ github.event.inputs.vm-name }}"
            echo "ä½¿ç”¨æ‰‹å‹•è§¸ç™¼çš„åç¨±: $VM_NAME"
          else
            VM_NAME="a1-flex-vm"
            echo "ç‚ºå®šæ™‚ä»»å‹™ä½¿ç”¨å›ºå®šåç¨±: $VM_NAME"
          fi
          echo "vm_name=$VM_NAME" >> "$GITHUB_OUTPUT"

      - name: æª¢æŸ¥åŒå VM æ˜¯å¦å·²å­˜åœ¨
        id: check-vm-exists
        run: |
          VM_NAME_TO_CHECK="${{ steps.determine-vm-name.outputs.vm_name }}"
          echo "æ­£åœ¨æª¢æŸ¥ VM åç¨±: $VM_NAME_TO_CHECK"
          set +e
          # <--- å„ªåŒ–é» 3ï¼šå¢åŠ äº† STOPPED å’Œ STOPPING ç‹€æ…‹çš„æª¢æŸ¥
          EXISTING_VM_OCID=$(oci compute instance list \
            --compartment-id "${{ env.OCI_COMPARTMENT_ID }}" \
            --display-name "$VM_NAME_TO_CHECK" \
            --lifecycle-state RUNNING \
            --lifecycle-state PROVISIONING \
            --lifecycle-state STARTING \
            --lifecycle-state STOPPED \
            --lifecycle-state STOPPING \
            --query 'data[0].id' --raw-output)
          exit_code=$?
          set -e
          if [ $exit_code -ne 0 ]; then
            echo "âš ï¸  OCI CLI æŸ¥è©¢å‘½ä»¤å¤±æ•—ï¼Œç„¡æ³•æª¢æŸ¥ VM æ˜¯å¦å­˜åœ¨ã€‚ç‚ºå®‰å…¨èµ·è¦‹ï¼Œå°‡è·³éå‰µå»ºã€‚"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          elif [ -n "$EXISTING_VM_OCID" ] && [ "$EXISTING_VM_OCID" != "null" ]; then
            echo "âŒ ç™¼ç¾å·²å­˜åœ¨çš„åŒå VM (å«å·²åœæ­¢): $VM_NAME_TO_CHECK"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… æœªç™¼ç¾åŒåçš„æ´»å‹• VMï¼Œå¯ä»¥ç¹¼çºŒã€‚"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ç”Ÿæˆ cloud-init è…³æœ¬
        if: steps.check-vm-exists.outputs.exists == 'false'
        run: |
          cat > cloud-init.txt << EOF
          #cloud-config
          users:
            - name: root
              lock_passwd: false
          chpasswd:
            list: |
              root:${{ secrets.ROOT_PASSWORD }}
            expire: false
          runcmd:
            - sed -i 's/^#?PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/^#?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd || systemctl restart ssh
          EOF

      - name: åŸ·è¡Œå‰µå»º VM çš„è…³æœ¬
        id: create-vm-script
        if: steps.check-vm-exists.outputs.exists == 'false'
        env:
          INPUT_VM_NAME: ${{ steps.determine-vm-name.outputs.vm_name }}
        run: |
          chmod +x ./scripts/create_vm.sh
          ./scripts/create_vm.sh
      
      - name: ç­‰å¾…å¯¦ä¾‹é”åˆ° RUNNING ç‹€æ…‹
        if: steps.check-vm-exists.outputs.exists == 'false' && steps.create-vm-script.outputs.success == 'true'
        id: wait-for-running
        run: |
          oci compute instance wait-for-state --instance-id "${{ steps.create-vm-script.outputs.instance_ocid }}" --wait-for-state "RUNNING" --wait-interval-seconds 15

      - name: ç²å–è™›æ“¬æ©Ÿå™¨å…¬ç¶² IP
        if: steps.check-vm-exists.outputs.exists == 'false' && steps.create-vm-script.outputs.success == 'true'
        id: get-ip
        run: |
          PUBLIC_IP=$(oci compute instance list-vnics --instance-id "${{ steps.create-vm-script.outputs.instance_ocid }}" --query 'data[0]."public-ip"' --raw-output)
          echo "public_ip=$PUBLIC_IP" >> "$GITHUB_OUTPUT"

  notify:
    name: Send Telegram Notification
    needs: create-vm
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ç™¼é€ Telegram é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            ${{ needs.create-vm.outputs.vm_exists == 'true' && format('
            <b>OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹ - æ“ä½œå–æ¶ˆ</b>
            â€¢ <b>è§¸ç™¼æ–¹å¼:</b> {0}
            â€¢ <b>åŸ·è¡Œæ™‚é–“:</b> {1}
            â€¢ <b>ç‹€æ…‹:</b> ğŸŸ¡ å·²è·³é
            â€¢ <b>åŸå› :</b> åç‚º "{2}" çš„è™›æ“¬æ©Ÿå™¨å·²å­˜åœ¨æˆ–æª¢æŸ¥æ™‚å‡ºéŒ¯ã€‚
            â€¢ <b>å€åŸŸ:</b> {3}
            â€¢ <b>è©³æƒ…:</b> <a href="https://github.com/{4}/actions/runs/{5}">æŸ¥çœ‹æ—¥èªŒ</a>', github.event_name == 'workflow_dispatch' && 'æ‰‹å‹•è§¸ç™¼' || 'å®šæ™‚ä»»å‹™', needs.create-vm.outputs.time, needs.create-vm.outputs.checked_vm_name, env.OCI_REGION, github.repository, github.run_id) || format('
            <b>OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹çµæœ</b>
            â€¢ <b>è§¸ç™¼æ–¹å¼:</b> {0}
            â€¢ <b>åŸ·è¡Œæ™‚é–“:</b> {1}
            â€¢ <b>ç‹€æ…‹:</b> {2}
            â€¢ <b>å˜—è©¦æ¬¡æ•¸:</b> {3}
            â€¢ <b>è¨Šæ¯:</b> {4}
            â€¢ <b>å€åŸŸ:</b> {5}
            â€¢ <b>è©³æƒ…:</b> <a href="https://github.com/{6}/actions/runs/{7}">æŸ¥çœ‹æ—¥èªŒ</a>
            {8}', github.event_name == 'workflow_dispatch' && 'æ‰‹å‹•è§¸ç™¼' || 'å®šæ™‚ä»»å‹™', needs.create-vm.outputs.time, needs.create-vm.outputs.creation_status == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—', needs.create-vm.outputs.attempt_count, needs.create-vm.outputs.creation_status == 'true' && 'VM å‰µå»ºæˆåŠŸ' || needs.create-vm.outputs.error_message, env.OCI_REGION, github.repository, github.run_id, needs.create-vm.outputs.creation_status == 'true' && format('
            <b>VM è³‡è¨Š</b>
            â€¢ <b>è™›æ“¬æ©Ÿå™¨åç¨±:</b> {0}
            â€¢ <b>å…¬ç¶² IP:</b> {1}', needs.create-vm.outputs.vm_name, needs.create-vm.outputs.public_ip) || '') }}
