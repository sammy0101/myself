name: '[Scheduled] Create OCI A1 Flex VM'

on:
  # 每天 UTC 时间 00:30 自动执行
  schedule:
    - cron: '30 0 * * *'
  # 保留手动触发功能
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'Name of the VM instance'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OCI CLI and network tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dnsutils jq
          pip install oci-cli
          oci --version

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          EOF
          
          cat > ~/.oci/oci_api_key.pem << EOF
          ${{ secrets.OCI_API_KEY }}
          EOF
          
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: Show current configuration and time
        run: |
          echo "当前时间: $(date)"
          echo "当前配置:"
          echo "区域: ${{ secrets.OCI_REGION }}"
          echo "可用性域: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}"
          echo "实例形状: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"

      - name: Generate cloud-init script for root login
        run: |
          cat > cloud-init.txt << 'EOF'
          #cloud-config
          users:
            - name: root
              password: $ROOT_PASSWORD
              lock_passwd: false
          chpasswd:
            list: |
              root:$ROOT_PASSWORD
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
          EOF
          
          sed -i "s/\$ROOT_PASSWORD/${{ secrets.ROOT_PASSWORD }}/g" cloud-init.txt

      - name: Create A1 Flex VM Instance with error handling
        id: create-vm
        run: |
          set +e  # 允许命令失败而不立即退出
          
          max_retries=2
          retry_delay=30
          
          # 如果是定时任务，使用固定名称；如果是手动触发，使用输入的名称
          if [ -n "${{ github.event.inputs.vm-name }}" ]; then
            VM_NAME="${{ github.event.inputs.vm-name }}"
          else
            VM_NAME="scheduled-a1-vm-$(date +%Y%m%d)"
          fi
          
          for i in $(seq 1 $max_retries); do
            echo "Attempt $i of $max_retries"
            
            # 运行 OCI 命令并捕获输出
            output=$(oci compute instance launch \
              --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
              --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
              --display-name "$VM_NAME" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
              --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
              --assign-public-ip true \
              --user-data-file ./cloud-init.txt 2>&1)
            
            exit_code=$?
            
            if [ $exit_code -eq 0 ]; then
              echo "✅ VM creation successful"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
              break
            else
              echo "❌ Attempt $i failed with exit code: $exit_code"
              echo "Error output: $output"
              
              # 检查是否是免费账户资源不足
              if echo "$output" | grep -i "out of host capacity\|insufficientcapacity\|outofcapacity"; then
                echo "free_tier_limit=true" >> $GITHUB_OUTPUT
                echo "error_type=free_tier_limit" >> $GITHUB_OUTPUT
                echo "error_message=免费账户资源限制: 当前区域或可用性域中没有足够的资源来创建虚拟机" >> $GITHUB_OUTPUT
              elif echo "$output" | grep -i "quota\|limit\|notavailable\|free tier\|insufficient"; then
                echo "free_tier_limit=true" >> $GITHUB_OUTPUT
                echo "error_type=free_tier_limit" >> $GITHUB_OUTPUT
                echo "error_message=免费账户资源限制，可能区域资源不足或已达免费额度上限" >> $GITHUB_OUTPUT
              elif echo "$output" | grep -i "timeout\|connection"; then
                echo "error_type=network_timeout" >> $GITHUB_OUTPUT
                echo "error_message=网络连接超时，请稍后重试" >> $GITHUB_OUTPUT
              else
                echo "error_type=other" >> $GITHUB_OUTPUT
                echo "error_message=其他错误，请检查配置和权限" >> $GITHUB_OUTPUT
              fi
              
              if [ $i -eq $max_retries ]; then
                echo "All attempts failed."
                break
              fi
              
              echo "Waiting $retry_delay seconds before retry..."
              sleep $retry_delay
            fi
          done
          
          set -e  # 恢复错误退出

      - name: Wait for VM initialization
        if: steps.create-vm.outputs.success == 'true'
        run: |
          echo "等待虚拟机初始化完成..."
          sleep 60

      - name: Get VM Public IP
        if: steps.create-vm.outputs.success == 'true'
        id: get-ip
        run: |
          PUBLIC_IP=$(oci compute instance list \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --display-name "${{ steps.create-vm.outputs.vm_name }}" \
            --lifecycle-state RUNNING \
            --query 'data[0]."public-ip"' \
            --raw-output)
          
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" == "null" ]; then
            echo "❌ 无法获取虚拟机公网IP"
            echo "这可能是因为:"
            echo "1. 虚拟机没有分配公网IP"
            echo "2. 虚拟机没有成功启动"
            echo "public_ip=unknown" >> $GITHUB_OUTPUT
          else
            echo "public_ip=${PUBLIC_IP}" >> $GITHUB_OUTPUT
            echo "VM Public IP: ${PUBLIC_IP}"
          fi

      - name: Prepare Telegram notification message
        id: prepare-telegram-message
        run: |
          # 准备 Telegram 消息内容
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            MESSAGE="✅ OCI 虚拟机创建成功
            • 名称: ${{ steps.create-vm.outputs.vm_name }}
            • IP: ${{ steps.get-ip.outputs.public_ip }}
            • 配置: A1.Flex (4 OCPU, 24GB RAM)
            • 时间: $(date +'%Y-%m-%d %H:%M:%S UTC')
            • 登录: ssh root@${{ steps.get-ip.outputs.public_ip }}"
          else
            MESSAGE="❌ OCI 虚拟机创建失败
            • 错误: ${{ steps.create-vm.outputs.error_message }}
            • 时间: $(date +'%Y-%m-%d %H:%M:%S UTC')
            • 区域: ${{ secrets.OCI_REGION }}
            • 详情: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          # 移除多余缩进并存储消息
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" | sed 's/^            //g' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.prepare-telegram-message.outputs.message }}
          format: html

      - name: Print Final Result
        if: always()
        run: |
          echo "=== 执行结果汇总 ==="
          echo "执行时间: $(date)"
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            echo "✅ 工作流执行成功: 虚拟机已创建并配置完成"
            echo "虚拟机名称: ${{ steps.create-vm.outputs.vm_name }}"
            echo "公网 IP: ${{ steps.get-ip.outputs.public_ip }}"
          else
            echo "❌ 工作流执行失败: 虚拟机创建未成功"
            echo "错误类型: ${{ steps.create-vm.outputs.error_type }}"
            echo "请查看上述错误信息和建议"
          fi
