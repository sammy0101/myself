name: '[Scheduled] Create OCI A1 Flex VM'

on:
  # æ¯å¤© UTC æ™‚é–“ 0 é»å’Œ 12 é»å„é‹è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 0,12 * * *'
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'è™šæ‹Ÿæœºå™¨çš„åç§°'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python and OCI CLI
        run: |
          # æ£€æŸ¥ Python ç‰ˆæœ¬ (OCI CLI éœ€è¦ Python 3.6+)
          echo "å½“å‰ Python ç‰ˆæœ¬: $(python3 --version)"
          python3 -c "import sys; assert sys.version_info >= (3, 6), 'Python 3.6+ required'; print('âœ… Python ç‰ˆæœ¬ç¬¦åˆè¦æ±‚')"
          
          # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ OCI CLI (ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ)
          pip install oci-cli==3.64.1 --user
          
          # å°†ç”¨æˆ·ç«™ç‚¹åŒ…æ·»åŠ åˆ° PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # éªŒè¯å®‰è£…
          oci --version
          echo "âœ… OCI CLI ç‰ˆæœ¬: $(oci --version)"

      - name: Install additional dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dnsutils jq ssh-client

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          EOF
          
          cat > ~/.oci/oci_api_key.pem << EOF
          ${{ secrets.OCI_API_KEY }}
          EOF
          
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: Show current configuration
        run: |
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "å½“å‰é…ç½®:"
          echo "åŒºåŸŸ: ${{ secrets.OCI_REGION }}"
          echo "å¯ç”¨æ€§åŸŸ: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}"
          echo "å®ä¾‹è§„æ ¼: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"
          echo "OCI CLI ç‰ˆæœ¬: $(oci --version)"

      - name: Generate cloud-init script for root login
        run: |
          cat > cloud-init.txt << 'EOF'
          #cloud-config
          users:
            - name: root
              password: $ROOT_PASSWORD
              lock_passwd: false
          chpasswd:
            list: |
              root:$ROOT_PASSWORD
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
            - apt-get update && apt-get install -y openssh-server
          EOF
          
          sed -i "s/\$ROOT_PASSWORD/${{ secrets.ROOT_PASSWORD }}/g" cloud-init.txt

      - name: Create A1 Flex VM Instance with Retry Mechanism
        id: create-vm
        run: |
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥è€Œä¸ç«‹å³é€€å‡º
          
          # é‡è¯•å‚æ•°é…ç½®
          max_retries=4           # æœ€å¤šé‡è¯•4æ¬¡ï¼ˆå…±5æ¬¡å°è¯•ï¼‰
          retry_delay=300         # æ¯æ¬¡é‡è¯•å»¶è¿Ÿ300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
          total_attempts=0
          
          # å†³å®šè™šæ‹Ÿæœºåç§°
          if [ -n "${{ github.event.inputs.vm-name }}" ]; then
            VM_NAME="${{ github.event.inputs.vm-name }}"
          else
            VM_NAME="scheduled-a1-vm-$(date +%Y%m%d-%H%M)"
          fi
          
          echo "å¼€å§‹åˆ›å»ºè™šæ‹Ÿæœº: $VM_NAME"
          echo "é‡è¯•ç­–ç•¥: æœ€å¤š $max_retries æ¬¡é‡è¯•ï¼Œæ¯æ¬¡å»¶è¿Ÿ $retry_delay ç§’"
          
          for attempt in $(seq 0 $max_retries); do
            total_attempts=$((attempt + 1))
            echo "--- å°è¯•ç¬¬ $total_attempts æ¬¡åˆ›å»º ---"
            
            # æ‰§è¡Œ OCI å‘½ä»¤åˆ›å»ºè™šæ‹Ÿæœºï¼Œå¹¶æ•è· JSON è¾“å‡º
            output=$(oci compute instance launch \
              --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
              --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
              --display-name "$VM_NAME" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
              --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
              --assign-public-ip true \
              --user-data-file ./cloud-init.txt \
              --output json 2>&1)
            
            exit_code=$?
            
            if [ $exit_code -eq 0 ]; then
              # ä» JSON è¾“å‡ºä¸­æå–å®ä¾‹ OCID
              INSTANCE_OCID=$(echo "$output" | jq -r '.data.id')
              
              if [ -n "$INSTANCE_OCID" ] && [ "$INSTANCE_OCID" != "null" ]; then
                echo "âœ… è™šæ‹Ÿæœºåˆ›å»ºæˆåŠŸ (ç¬¬ $total_attempts æ¬¡å°è¯•)"
                echo "success=true" >> $GITHUB_OUTPUT
                echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
                echo "instance_ocid=$INSTANCE_OCID" >> $GITHUB_OUTPUT
                echo "attempt_count=$total_attempts" >> $GITHUB_OUTPUT
                echo "Instance OCID: $INSTANCE_OCID"
                break
              else
                echo "âŒ æ— æ³•ä»è¾“å‡ºä¸­è§£æ Instance OCID"
                echo "output: $output"
              fi
            else
              echo "âŒ ç¬¬ $total_attempts æ¬¡å°è¯•å¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
              echo "é”™è¯¯è¾“å‡º: $output"
              
              # æ£€æŸ¥é”™è¯¯ç±»å‹
              if echo "$output" | grep -Ei "out of host capacity|insufficientcapacity|outofcapacity|service limit exceeded|limit exceeded|capacity not available|not available|host capacity"; then
                echo "æ£€æµ‹åˆ°å®¹é‡ä¸è¶³é”™è¯¯ï¼Œå°†åœ¨å»¶è¿Ÿåé‡è¯•..."
                error_type="capacity_error"
              elif echo "$output" | grep -Ei "quota|limit|notavailable|free tier|insufficient|over quota"; then
                echo "æ£€æµ‹åˆ°é…é¢é™åˆ¶é”™è¯¯"
                error_type="quota_error"
                break  # é…é¢é”™è¯¯é‡è¯•æ— æ„ä¹‰
              elif echo "$output" | grep -Ei "timeout|connection|request timed out"; then
                echo "æ£€æµ‹åˆ°ç½‘ç»œè¶…æ—¶é”™è¯¯ï¼Œå°†åœ¨å»¶è¿Ÿåé‡è¯•..."
                error_type="network_error"
              else
                echo "æ£€æµ‹åˆ°å…¶ä»–é”™è¯¯ç±»å‹"
                error_type="other_error"
                break  # å…¶ä»–é”™è¯¯å¯èƒ½é‡è¯•ä¹Ÿæ— æ„ä¹‰
              fi
              
              # å­˜å‚¨é”™è¯¯ä¿¡æ¯
              echo "free_tier_limit=true" >> $GITHUB_OUTPUT
              echo "error_type=$error_type" >> $GITHUB_OUTPUT
              echo "error_message=ç¬¬ $total_attempts æ¬¡å°è¯•å¤±è´¥: $(echo "$output" | head -5)" >> $GITHUB_OUTPUT
            fi
            
            # å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸å†å»¶è¿Ÿ
            if [ $attempt -eq $max_retries ]; then
              echo "å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•° ($max_retries æ¬¡)ï¼Œåœæ­¢é‡è¯•"
              break
            fi
            
            echo "ç­‰å¾… $retry_delay ç§’åé‡è¯•..."
            sleep $retry_delay
          done
          
          # æ¢å¤é”™è¯¯å¤„ç†
          set -e

      - name: Wait for instance to reach RUNNING state
        if: steps.create-vm.outputs.success == 'true'
        id: wait-for-running
        run: |
          INSTANCE_OCID="${{ steps.create-vm.outputs.instance_ocid }}"
          echo "ç­‰å¾…å®ä¾‹ $INSTANCE_OCID è¿›å…¥ RUNNING çŠ¶æ€..."
          
          # è®¾ç½®è½®è¯¢å‚æ•°ï¼ˆå»¶é•¿åˆ°10åˆ†é’Ÿï¼‰
          MAX_ATTEMPTS=60  # æœ€å¤šå°è¯•60æ¬¡ (10åˆ†é’Ÿ)
          SLEEP_INTERVAL=10  # æ¯æ¬¡é—´éš”10ç§’
          attempt=1
          
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            # ä½¿ç”¨ç²¾ç¡®çš„å®ä¾‹OCIDæŸ¥è¯¢å½“å‰çŠ¶æ€
            CURRENT_STATE=$(oci compute instance get \
              --instance-id "$INSTANCE_OCID" \
              --query 'data."lifecycle-state"' \
              --raw-output 2>/dev/null || echo "UNKNOWN")
            
            echo "çŠ¶æ€æ£€æŸ¥ $attempt/$MAX_ATTEMPTS: å½“å‰çŠ¶æ€ä¸º '$CURRENT_STATE'"
            
            if [ "$CURRENT_STATE" = "RUNNING" ]; then
              echo "âœ… å®ä¾‹ç°åœ¨å¤„äº RUNNING çŠ¶æ€"
              echo "running=true" >> $GITHUB_OUTPUT
              break
            fi
            
            if [ $attempt -eq $MAX_ATTEMPTS ]; then
              echo "âŒ å®ä¾‹æœªåœ¨è¶…æ—¶æ—¶é—´å†…è¾¾åˆ° RUNNING çŠ¶æ€"
              echo "running=false" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep $SLEEP_INTERVAL
            ((attempt++))
          done

      - name: Get VM Public IP (Precise Query)
        if: steps.create-vm.outputs.success == 'true' && steps.wait-for-running.outputs.running == 'true'
        id: get-ip
        run: |
          INSTANCE_OCID="${{ steps.create-vm.outputs.instance_ocid }}"
          echo "è·å–å®ä¾‹çš„å…¬ç½‘ IP: $INSTANCE_OCID"
          
          # ä½¿ç”¨ç²¾ç¡®çš„å®ä¾‹OCIDæŸ¥è¯¢å…¬ç½‘IP
          PUBLIC_IP=$(oci compute instance get \
            --instance-id "$INSTANCE_OCID" \
            --query 'data."public-ip"' \
            --raw-output)
          
          # æ£€æŸ¥è·å–åˆ°çš„IPæ˜¯å¦æœ‰æ•ˆ
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" = "null" ]; then
            echo "âŒ æ— æ³•è·å–æœ‰æ•ˆçš„å…¬ç½‘IPåœ°å€ã€‚å¯èƒ½å°šæœªåˆ†é…ã€‚"
            echo "public_ip=unknown" >> $GITHUB_OUTPUT
          else
            echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
            echo "âœ… è™šæ‹Ÿæœºå…¬ç½‘ IP: $PUBLIC_IP"
          fi

      - name: SSH Health Check
        if: steps.create-vm.outputs.success == 'true' && steps.wait-for-running.outputs.running == 'true' && steps.get-ip.outputs.public_ip != 'unknown'
        id: ssh-health-check
        run: |
          PUBLIC_IP="${{ steps.get-ip.outputs.public_ip }}"
          ROOT_PASSWORD="${{ secrets.ROOT_PASSWORD }}"
          
          echo "æ‰§è¡ŒSSHå¥åº·æ£€æŸ¥ï¼Œç›®æ ‡IP: $PUBLIC_IP"
          echo "è¿™å°†å°è¯•é€šè¿‡SSHè¿æ¥åˆ°è™šæ‹Ÿæœºå¹¶æ‰§è¡ŒåŸºæœ¬æ£€æŸ¥..."
          
          # å®‰è£…sshpassç”¨äºéäº¤äº’å¼SSHè®¤è¯
          echo "å®‰è£…sshpass..."
          sudo apt-get install -y sshpass
          
          # è®¾ç½®æœ€å¤§å¥åº·æ£€æŸ¥å°è¯•æ¬¡æ•°
          MAX_HEALTH_CHECKS=12
          HEALTH_CHECK_INTERVAL=10
          health_attempt=1
          health_success=false
          
          while [ $health_attempt -le $MAX_HEALTH_CHECKS ]; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $health_attempt/$MAX_HEALTH_CHECKS..."
            
            # ä½¿ç”¨sshpassæ‰§è¡ŒSSHå‘½ä»¤ï¼ˆç¦ç”¨ä¸¥æ ¼ä¸»æœºå¯†é’¥æ£€æŸ¥ï¼‰
            if sshpass -p "$ROOT_PASSWORD" ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=10 root@$PUBLIC_IP 'echo "SSHè¿æ¥æˆåŠŸ"; hostname; uptime'; then
              echo "âœ… SSHå¥åº·æ£€æŸ¥æˆåŠŸ"
              health_success=true
              break
            else
              echo "âŒ SSHå¥åº·æ£€æŸ¥å¤±è´¥ (å°è¯• $health_attempt)ï¼Œç­‰å¾…é‡è¯•..."
              sleep $HEALTH_CHECK_INTERVAL
              ((health_attempt++))
            fi
          done
          
          if [ "$health_success" = true ]; then
            echo "health_check=passed" >> $GITHUB_OUTPUT
          else
            echo "health_check=failed" >> $GITHUB_OUTPUT
            echo "âŒ æ‰€æœ‰SSHå¥åº·æ£€æŸ¥å°è¯•å‡å¤±è´¥"
          fi

      - name: Prepare Telegram notification message
        id: prepare-telegram-message
        run: |
          # å‡†å¤‡ Telegram æ¶ˆæ¯å†…å®¹
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            if [[ "${{ steps.ssh-health-check.outputs.health_check }}" == "passed" ]]; then
              MESSAGE="âœ… OCI è™šæ‹Ÿæœºåˆ›å»ºå¹¶éªŒè¯æˆåŠŸ
              â€¢ åç§°: ${{ steps.create-vm.outputs.vm_name }}
              â€¢ IP: ${{ steps.get-ip.outputs.public_ip }}
              â€¢ é…ç½®: A1.Flex (4 OCPU, 24GB RAM)
              â€¢ å°è¯•æ¬¡æ•°: ${{ steps.create-vm.outputs.attempt_count }}
              â€¢ å¥åº·æ£€æŸ¥: é€šè¿‡
              â€¢ æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')
              â€¢ ç™»å½•: ssh root@${{ steps.get-ip.outputs.public_ip }}"
            else
              MESSAGE="âš ï¸ OCI è™šæ‹Ÿæœºåˆ›å»ºä½†å¥åº·æ£€æŸ¥å¤±è´¥
              â€¢ åç§°: ${{ steps.create-vm.outputs.vm_name }}
              â€¢ IP: ${{ steps.get-ip.outputs.public_ip }}
              â€¢ é…ç½®: A1.Flex (4 OCPU, 24GB RAM)
              â€¢ å°è¯•æ¬¡æ•°: ${{ steps.create-vm.outputs.attempt_count }}
              â€¢ å¥åº·æ£€æŸ¥: å¤±è´¥
              â€¢ æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')
              â€¢ å¯èƒ½éœ€è¦æ‰‹åŠ¨æ£€æŸ¥å®ä¾‹çŠ¶æ€"
            fi
          else
            MESSAGE="âŒ OCI è™šæ‹Ÿæœºåˆ›å»ºå¤±è´¥
            â€¢ é”™è¯¯: ${{ steps.create-vm.outputs.error_message }}
            â€¢ å°è¯•æ¬¡æ•°: ${{ steps.create-vm.outputs.attempt_count }}
            â€¢ æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')
            â€¢ åŒºåŸŸ: ${{ secrets.OCI_REGION }}
            â€¢ è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          # ç§»é™¤å¤šä½™ç¼©è¿›å¹¶å­˜å‚¨æ¶ˆæ¯
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" | sed 's/^              //g' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.prepare-telegram-message.outputs.message }}
          format: html

      - name: Handle final result
        if: always()
        run: |
          echo "=== æ‰§è¡Œç»“æœæ±‡æ€» ==="
          echo "æ‰§è¡Œæ—¶é—´: $(date)"
          echo "æ‰§è¡Œæ¨¡å¼: ${{ github.event_name }}"
          
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            if [[ "${{ steps.wait-for-running.outputs.running }}" == "true" ]]; then
              if [[ "${{ steps.ssh-health-check.outputs.health_check }}" == "passed" ]]; then
                echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ: è™šæ‹Ÿæœºå·²åˆ›å»ºã€é…ç½®å¹¶é€šè¿‡å¥åº·æ£€æŸ¥"
              else
                echo "âš ï¸  è™šæ‹Ÿæœºå·²åˆ›å»ºä½†å¥åº·æ£€æŸ¥å¤±è´¥"
              fi
              echo "è™šæ‹Ÿæœºåç§°: ${{ steps.create-vm.outputs.vm_name }}"
              echo "å…¬ç½‘ IP: ${{ steps.get-ip.outputs.public_ip }}"
              echo "å°è¯•æ¬¡æ•°: ${{ steps.create-vm.outputs.attempt_count }}"
            else
              echo "âš ï¸  è™šæ‹Ÿæœºå·²åˆ›å»ºä½†æœªè¾¾åˆ° RUNNING çŠ¶æ€"
              echo "è™šæ‹Ÿæœº OCID: ${{ steps.create-vm.outputs.instance_ocid }}"
              echo "è¯·ç¨ååœ¨ OCI æ§åˆ¶å°ä¸­æ£€æŸ¥çŠ¶æ€"
            fi
          else
            echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥: è™šæ‹Ÿæœºåˆ›å»ºæœªæˆåŠŸ"
            echo "é”™è¯¯ç±»å‹: ${{ steps.create-vm.outputs.error_type }}"
            echo "å°è¯•æ¬¡æ•°: ${{ steps.create-vm.outputs.attempt_count }}"
            echo "é”™è¯¯ä¿¡æ¯: ${{ steps.create-vm.outputs.error_message }}"
            
            # å…è´¹è´¦æˆ·èµ„æºé™åˆ¶çš„ç‰¹æ®Šæç¤º
            if [[ "${{ steps.create-vm.outputs.free_tier_limit }}" == "true" ]]; then
              echo ""
              echo "ğŸ’¡ Oracle Cloud å…è´¹è´¦æˆ·åˆ›å»ºè™šæ‹Ÿæœºå¤±è´¥å»ºè®®:"
              echo "1. å°è¯•ä½¿ç”¨ä¸åŒçš„å¯ç”¨æ€§åŸŸ"
              echo "2. ç¨åé‡è¯• (å‡ å°æ—¶æˆ–ç¬¬äºŒå¤©)"
              echo "3. è€ƒè™‘ä½¿ç”¨ä¸åŒçš„åŒºåŸŸ"
              echo "4. å°è¯•åˆ›å»ºè¾ƒå°é…ç½®çš„å®ä¾‹"
            fi
          fi
