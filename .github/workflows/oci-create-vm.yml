name: '[Scheduled] Create OCI A1 Flex VM'

on:
  # 每天 UTC 時間 0 點和 12 點各運行一次
  schedule:
    - cron: '0 0,12 * * *'
  # 保留手动触发功能
  workflow_dispatch:
    inputs:
      vm-name:
        description: '虚拟机器的名称'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python and OCI CLI
        run: |
          # 检查 Python 版本 (OCI CLI 需要 Python 3.6+)
          echo "当前 Python 版本: $(python3 --version)"
          python3 -c "import sys; assert sys.version_info >= (3, 6), 'Python 3.6+ required'; print('✅ Python 版本符合要求')"
          
          # 安装指定版本的 OCI CLI (使用最新稳定版)
          pip install oci-cli==3.64.1 --user
          
          # 将用户站点包添加到 PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # 验证安装
          oci --version
          echo "✅ OCI CLI 版本: $(oci --version)"

      - name: Install additional dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dnsutils jq ssh-client

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          EOF
          
          cat > ~/.oci/oci_api_key.pem << EOF
          ${{ secrets.OCI_API_KEY }}
          EOF
          
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: Show current configuration
        run: |
          echo "当前时间: $(date)"
          echo "当前配置:"
          echo "区域: ${{ secrets.OCI_REGION }}"
          echo "可用性域: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}"
          echo "实例规格: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"
          echo "OCI CLI 版本: $(oci --version)"

      - name: Generate cloud-init script for root login
        run: |
          cat > cloud-init.txt << 'EOF'
          #cloud-config
          users:
            - name: root
              password: $ROOT_PASSWORD
              lock_passwd: false
          chpasswd:
            list: |
              root:$ROOT_PASSWORD
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
            - apt-get update && apt-get install -y openssh-server
          EOF
          
          sed -i "s/\$ROOT_PASSWORD/${{ secrets.ROOT_PASSWORD }}/g" cloud-init.txt

      - name: Create A1 Flex VM Instance with Retry Mechanism
        id: create-vm
        run: |
          set +e  # 允许命令失败而不立即退出
          
          # 重试参数配置
          max_retries=4           # 最多重试4次（共5次尝试）
          retry_delay=300         # 每次重试延迟300秒（5分钟）
          total_attempts=0
          
          # 决定虚拟机名称
          if [ -n "${{ github.event.inputs.vm-name }}" ]; then
            VM_NAME="${{ github.event.inputs.vm-name }}"
          else
            VM_NAME="scheduled-a1-vm-$(date +%Y%m%d-%H%M)"
          fi
          
          echo "开始创建虚拟机: $VM_NAME"
          echo "重试策略: 最多 $max_retries 次重试，每次延迟 $retry_delay 秒"
          
          for attempt in $(seq 0 $max_retries); do
            total_attempts=$((attempt + 1))
            echo "--- 尝试第 $total_attempts 次创建 ---"
            
            # 执行 OCI 命令创建虚拟机，并捕获 JSON 输出
            output=$(oci compute instance launch \
              --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
              --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
              --display-name "$VM_NAME" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
              --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
              --assign-public-ip true \
              --user-data-file ./cloud-init.txt \
              --output json 2>&1)
            
            exit_code=$?
            
            if [ $exit_code -eq 0 ]; then
              # 从 JSON 输出中提取实例 OCID
              INSTANCE_OCID=$(echo "$output" | jq -r '.data.id')
              
              if [ -n "$INSTANCE_OCID" ] && [ "$INSTANCE_OCID" != "null" ]; then
                echo "✅ 虚拟机创建成功 (第 $total_attempts 次尝试)"
                echo "success=true" >> $GITHUB_OUTPUT
                echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
                echo "instance_ocid=$INSTANCE_OCID" >> $GITHUB_OUTPUT
                echo "attempt_count=$total_attempts" >> $GITHUB_OUTPUT
                echo "Instance OCID: $INSTANCE_OCID"
                break
              else
                echo "❌ 无法从输出中解析 Instance OCID"
                echo "output: $output"
              fi
            else
              echo "❌ 第 $total_attempts 次尝试失败，退出码: $exit_code"
              echo "错误输出: $output"
              
              # 检查错误类型
              if echo "$output" | grep -Ei "out of host capacity|insufficientcapacity|outofcapacity|service limit exceeded|limit exceeded|capacity not available|not available|host capacity"; then
                echo "检测到容量不足错误，将在延迟后重试..."
                error_type="capacity_error"
              elif echo "$output" | grep -Ei "quota|limit|notavailable|free tier|insufficient|over quota"; then
                echo "检测到配额限制错误"
                error_type="quota_error"
                break  # 配额错误重试无意义
              elif echo "$output" | grep -Ei "timeout|connection|request timed out"; then
                echo "检测到网络超时错误，将在延迟后重试..."
                error_type="network_error"
              else
                echo "检测到其他错误类型"
                error_type="other_error"
                break  # 其他错误可能重试也无意义
              fi
              
              # 存储错误信息
              echo "free_tier_limit=true" >> $GITHUB_OUTPUT
              echo "error_type=$error_type" >> $GITHUB_OUTPUT
              echo "error_message=第 $total_attempts 次尝试失败: $(echo "$output" | head -5)" >> $GITHUB_OUTPUT
            fi
            
            # 如果是最后一次尝试，不再延迟
            if [ $attempt -eq $max_retries ]; then
              echo "已达最大重试次数 ($max_retries 次)，停止重试"
              break
            fi
            
            echo "等待 $retry_delay 秒后重试..."
            sleep $retry_delay
          done
          
          # 恢复错误处理
          set -e

      - name: Wait for instance to reach RUNNING state
        if: steps.create-vm.outputs.success == 'true'
        id: wait-for-running
        run: |
          INSTANCE_OCID="${{ steps.create-vm.outputs.instance_ocid }}"
          echo "等待实例 $INSTANCE_OCID 进入 RUNNING 状态..."
          
          # 设置轮询参数（延长到10分钟）
          MAX_ATTEMPTS=60  # 最多尝试60次 (10分钟)
          SLEEP_INTERVAL=10  # 每次间隔10秒
          attempt=1
          
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            # 使用精确的实例OCID查询当前状态
            CURRENT_STATE=$(oci compute instance get \
              --instance-id "$INSTANCE_OCID" \
              --query 'data."lifecycle-state"' \
              --raw-output 2>/dev/null || echo "UNKNOWN")
            
            echo "状态检查 $attempt/$MAX_ATTEMPTS: 当前状态为 '$CURRENT_STATE'"
            
            if [ "$CURRENT_STATE" = "RUNNING" ]; then
              echo "✅ 实例现在处于 RUNNING 状态"
              echo "running=true" >> $GITHUB_OUTPUT
              break
            fi
            
            if [ $attempt -eq $MAX_ATTEMPTS ]; then
              echo "❌ 实例未在超时时间内达到 RUNNING 状态"
              echo "running=false" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep $SLEEP_INTERVAL
            ((attempt++))
          done

      - name: Get VM Public IP (Precise Query)
        if: steps.create-vm.outputs.success == 'true' && steps.wait-for-running.outputs.running == 'true'
        id: get-ip
        run: |
          INSTANCE_OCID="${{ steps.create-vm.outputs.instance_ocid }}"
          echo "获取实例的公网 IP: $INSTANCE_OCID"
          
          # 使用精确的实例OCID查询公网IP
          PUBLIC_IP=$(oci compute instance get \
            --instance-id "$INSTANCE_OCID" \
            --query 'data."public-ip"' \
            --raw-output)
          
          # 检查获取到的IP是否有效
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" = "null" ]; then
            echo "❌ 无法获取有效的公网IP地址。可能尚未分配。"
            echo "public_ip=unknown" >> $GITHUB_OUTPUT
          else
            echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
            echo "✅ 虚拟机公网 IP: $PUBLIC_IP"
          fi

      - name: SSH Health Check
        if: steps.create-vm.outputs.success == 'true' && steps.wait-for-running.outputs.running == 'true' && steps.get-ip.outputs.public_ip != 'unknown'
        id: ssh-health-check
        run: |
          PUBLIC_IP="${{ steps.get-ip.outputs.public_ip }}"
          ROOT_PASSWORD="${{ secrets.ROOT_PASSWORD }}"
          
          echo "执行SSH健康检查，目标IP: $PUBLIC_IP"
          echo "这将尝试通过SSH连接到虚拟机并执行基本检查..."
          
          # 安装sshpass用于非交互式SSH认证
          echo "安装sshpass..."
          sudo apt-get install -y sshpass
          
          # 设置最大健康检查尝试次数
          MAX_HEALTH_CHECKS=12
          HEALTH_CHECK_INTERVAL=10
          health_attempt=1
          health_success=false
          
          while [ $health_attempt -le $MAX_HEALTH_CHECKS ]; do
            echo "健康检查尝试 $health_attempt/$MAX_HEALTH_CHECKS..."
            
            # 使用sshpass执行SSH命令（禁用严格主机密钥检查）
            if sshpass -p "$ROOT_PASSWORD" ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=10 root@$PUBLIC_IP 'echo "SSH连接成功"; hostname; uptime'; then
              echo "✅ SSH健康检查成功"
              health_success=true
              break
            else
              echo "❌ SSH健康检查失败 (尝试 $health_attempt)，等待重试..."
              sleep $HEALTH_CHECK_INTERVAL
              ((health_attempt++))
            fi
          done
          
          if [ "$health_success" = true ]; then
            echo "health_check=passed" >> $GITHUB_OUTPUT
          else
            echo "health_check=failed" >> $GITHUB_OUTPUT
            echo "❌ 所有SSH健康检查尝试均失败"
          fi

      - name: Prepare Telegram notification message
        id: prepare-telegram-message
        run: |
          # 准备 Telegram 消息内容
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            if [[ "${{ steps.ssh-health-check.outputs.health_check }}" == "passed" ]]; then
              MESSAGE="✅ OCI 虚拟机创建并验证成功
              • 名称: ${{ steps.create-vm.outputs.vm_name }}
              • IP: ${{ steps.get-ip.outputs.public_ip }}
              • 配置: A1.Flex (4 OCPU, 24GB RAM)
              • 尝试次数: ${{ steps.create-vm.outputs.attempt_count }}
              • 健康检查: 通过
              • 时间: $(date +'%Y-%m-%d %H:%M:%S UTC')
              • 登录: ssh root@${{ steps.get-ip.outputs.public_ip }}"
            else
              MESSAGE="⚠️ OCI 虚拟机创建但健康检查失败
              • 名称: ${{ steps.create-vm.outputs.vm_name }}
              • IP: ${{ steps.get-ip.outputs.public_ip }}
              • 配置: A1.Flex (4 OCPU, 24GB RAM)
              • 尝试次数: ${{ steps.create-vm.outputs.attempt_count }}
              • 健康检查: 失败
              • 时间: $(date +'%Y-%m-%d %H:%M:%S UTC')
              • 可能需要手动检查实例状态"
            fi
          else
            MESSAGE="❌ OCI 虚拟机创建失败
            • 错误: ${{ steps.create-vm.outputs.error_message }}
            • 尝试次数: ${{ steps.create-vm.outputs.attempt_count }}
            • 时间: $(date +'%Y-%m-%d %H:%M:%S UTC')
            • 区域: ${{ secrets.OCI_REGION }}
            • 详情: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          # 移除多余缩进并存储消息
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" | sed 's/^              //g' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.prepare-telegram-message.outputs.message }}
          format: html

      - name: Handle final result
        if: always()
        run: |
          echo "=== 执行结果汇总 ==="
          echo "执行时间: $(date)"
          echo "执行模式: ${{ github.event_name }}"
          
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            if [[ "${{ steps.wait-for-running.outputs.running }}" == "true" ]]; then
              if [[ "${{ steps.ssh-health-check.outputs.health_check }}" == "passed" ]]; then
                echo "✅ 工作流执行成功: 虚拟机已创建、配置并通过健康检查"
              else
                echo "⚠️  虚拟机已创建但健康检查失败"
              fi
              echo "虚拟机名称: ${{ steps.create-vm.outputs.vm_name }}"
              echo "公网 IP: ${{ steps.get-ip.outputs.public_ip }}"
              echo "尝试次数: ${{ steps.create-vm.outputs.attempt_count }}"
            else
              echo "⚠️  虚拟机已创建但未达到 RUNNING 状态"
              echo "虚拟机 OCID: ${{ steps.create-vm.outputs.instance_ocid }}"
              echo "请稍后在 OCI 控制台中检查状态"
            fi
          else
            echo "❌ 工作流执行失败: 虚拟机创建未成功"
            echo "错误类型: ${{ steps.create-vm.outputs.error_type }}"
            echo "尝试次数: ${{ steps.create-vm.outputs.attempt_count }}"
            echo "错误信息: ${{ steps.create-vm.outputs.error_message }}"
            
            # 免费账户资源限制的特殊提示
            if [[ "${{ steps.create-vm.outputs.free_tier_limit }}" == "true" ]]; then
              echo ""
              echo "💡 Oracle Cloud 免费账户创建虚拟机失败建议:"
              echo "1. 尝试使用不同的可用性域"
              echo "2. 稍后重试 (几小时或第二天)"
              echo "3. 考虑使用不同的区域"
              echo "4. 尝试创建较小配置的实例"
            fi
          fi
