name: '[Scheduled] Create OCI A1 Flex VM'

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'è™›æ“¬æ©Ÿå™¨çš„åç¨± (å¿…å¡«)'
        required: true
        default: 'a1-flex-vm'
        type: string

env:
  OCI_REGION: ${{ secrets.OCI_REGION }}
  OCI_AVAILABILITY_DOMAIN: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}
  OCI_COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
  OCI_SUBNET_ID: ${{ secrets.OCI_SUBNET_ID }}
  OCI_IMAGE_OCID: ${{ secrets.OCI_IMAGE_OCID }}
  VM_SHAPE: 'VM.Standard.A1.Flex'
  OCPU_COUNT: 4
  MEMORY_IN_GB: 24

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    outputs:
      time: ${{ steps.get-current-time.outputs.time }}
      vm_exists: ${{ steps.check-vm-exists.outputs.exists }}
      checked_vm_name: ${{ steps.check-vm-exists.outputs.vm_name }}
      creation_status: ${{ steps.create-vm-script.outputs.success }}
      attempt_count: ${{ steps.create-vm-script.outputs.attempt_count }}
      error_message: ${{ steps.create-vm-script.outputs.error_message }}
      vm_name: ${{ steps.create-vm-script.outputs.vm_name }}
      public_ip: ${{ steps.get-ip.outputs.public_ip }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ç²å–ç•¶å‰æ™‚é–“
        id: get-current-time
        run: echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: è¨­ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: æ‰‹å‹•å®‰è£èˆ‡é…ç½® OCI CLI
        run: |
          pip install oci-cli
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ env.OCI_REGION }}
          EOF
          echo "${{ secrets.OCI_API_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: é©—è­‰ OCI CLI é…ç½®
        run: |
          oci iam compartment list --compartment-id-in-subtree true --all --output table --query 'data[0:1].{Name:name, OCID:id}'
          echo "âœ… OCI é…ç½®é©—è­‰æˆåŠŸ"

      # <-- è®Šæ›´é» 1ï¼šæ–°å¢æª¢æŸ¥æ­¥é©Ÿ
      - name: æª¢æŸ¥åŒå VM æ˜¯å¦å·²å­˜åœ¨
        id: check-vm-exists
        run: |
          # æ±ºå®šè¦æª¢æŸ¥çš„ VM åç¨± (åƒ…åœ¨æ‰‹å‹•è§¸ç™¼æ™‚æª¢æŸ¥)
          VM_NAME_TO_CHECK=""
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.vm-name }}" ]; then
            VM_NAME_TO_CHECK="${{ github.event.inputs.vm-name }}"
            echo "æ­£åœ¨æª¢æŸ¥æ‰‹å‹•æŒ‡å®šçš„ VM åç¨±: $VM_NAME_TO_CHECK"
            
            # æŸ¥è©¢è™•æ–¼æ´»å‹•ç‹€æ…‹çš„åŒå VM
            EXISTING_VM_OCID=$(oci compute instance list \
              --compartment-id "${{ env.OCI_COMPARTMENT_ID }}" \
              --display-name "$VM_NAME_TO_CHECK" \
              --lifecycle-state RUNNING \
              --lifecycle-state PROVISIONING \
              --lifecycle-state STARTING \
              --query 'data[0].id' --raw-output)
              
            if [ -n "$EXISTING_VM_OCID" ] && [ "$EXISTING_VM_OCID" != "null" ]; then
              echo "âŒ ç™¼ç¾å·²å­˜åœ¨çš„åŒå VM: $VM_NAME_TO_CHECK (OCID: $EXISTING_VM_OCID)"
              echo "exists=true" >> "$GITHUB_OUTPUT"
              echo "vm_name=$VM_NAME_TO_CHECK" >> "$GITHUB_OUTPUT"
            else
              echo "âœ… æœªç™¼ç¾åŒåçš„æ´»å‹• VMï¼Œå¯ä»¥ç¹¼çºŒã€‚"
              echo "exists=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "â„¹ï¸  ç‚ºå®šæ™‚ä»»å‹™ï¼Œå°‡ç”Ÿæˆå”¯ä¸€åç¨±ï¼Œè·³éæª¢æŸ¥ã€‚"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ç”Ÿæˆ cloud-init è…³æœ¬
        # <-- è®Šæ›´é» 2ï¼šåƒ…åœ¨ VM ä¸å­˜åœ¨æ™‚åŸ·è¡Œ
        if: steps.check-vm-exists.outputs.exists == 'false'
        run: |
          # (cloud-init è…³æœ¬å…§å®¹ä¸è®Š)
          cat > cloud-init.txt << EOF
          #cloud-config
          users:
            - name: root
              lock_passwd: false
          chpasswd:
            list: |
              root:${{ secrets.ROOT_PASSWORD }}
            expire: false
          runcmd:
            - sed -i 's/^#?PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/^#?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd || systemctl restart ssh
          EOF

      - name: åŸ·è¡Œå‰µå»º VM çš„è…³æœ¬
        id: create-vm-script
        # <-- è®Šæ›´é» 3ï¼šåƒ…åœ¨ VM ä¸å­˜åœ¨æ™‚åŸ·è¡Œ
        if: steps.check-vm-exists.outputs.exists == 'false'
        env:
          INPUT_VM_NAME: ${{ github.event.inputs.vm-name }}
        run: |
          chmod +x ./scripts/create_vm.sh
          ./scripts/create_vm.sh

      - name: ç­‰å¾…å¯¦ä¾‹é”åˆ° RUNNING ç‹€æ…‹
        if: steps.check-vm-exists.outputs.exists == 'false' && steps.create-vm-script.outputs.success == 'true'
        id: wait-for-running
        run: |
          oci compute instance wait-for-state --instance-id "${{ steps.create-vm-script.outputs.instance_ocid }}" --wait-for-state "RUNNING" --wait-interval-seconds 15

      - name: ç²å–è™›æ“¬æ©Ÿå™¨å…¬ç¶² IP
        if: steps.check-vm-exists.outputs.exists == 'false' && steps.create-vm-script.outputs.success == 'true'
        id: get-ip
        run: |
          PUBLIC_IP=$(oci compute instance list-vnics --instance-id "${{ steps.create-vm-script.outputs.instance_ocid }}" --query 'data[0]."public-ip"' --raw-output)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          
  notify:
    name: Send Telegram Notification
    needs: create-vm
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ç™¼é€ Telegram é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          # <-- è®Šæ›´é» 4ï¼šé‡æ§‹é€šçŸ¥é‚è¼¯ä»¥è™•ç†ä¸‰ç¨®æƒ…æ³
          message: |
            ${{ needs.create-vm.outputs.vm_exists == 'true' && format('
            <b>OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹ - æ“ä½œå–æ¶ˆ</b>
            â€¢ <b>è§¸ç™¼æ–¹å¼:</b> æ‰‹å‹•è§¸ç™¼
            â€¢ <b>åŸ·è¡Œæ™‚é–“:</b> {0}
            â€¢ <b>ç‹€æ…‹:</b> ğŸŸ¡ å·²è·³é
            â€¢ <b>åŸå› :</b> åç‚º "{1}" çš„è™›æ“¬æ©Ÿå™¨å·²å­˜åœ¨ã€‚
            â€¢ <b>å€åŸŸ:</b> {2}
            â€¢ <b>è©³æƒ…:</b> <a href="https://github.com/{3}/actions/runs/{4}">æŸ¥çœ‹æ—¥èªŒ</a>', needs.create-vm.outputs.time, needs.create-vm.outputs.checked_vm_name, env.OCI_REGION, github.repository, github.run_id) || format('
            <b>OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹çµæœ</b>
            â€¢ <b>è§¸ç™¼æ–¹å¼:</b> {0}
            â€¢ <b>åŸ·è¡Œæ™‚é–“:</b> {1}
            â€¢ <b>ç‹€æ…‹:</b> {2}
            â€¢ <b>å˜—è©¦æ¬¡æ•¸:</b> {3}
            â€¢ <b>è¨Šæ¯:</b> {4}
            â€¢ <b>å€åŸŸ:</b> {5}
            â€¢ <b>è©³æƒ…:</b> <a href="https://github.com/{6}/actions/runs/{7}">æŸ¥çœ‹æ—¥èªŒ</a>
            {8}', github.event_name == 'workflow_dispatch' && 'æ‰‹å‹•è§¸ç™¼' || 'å®šæ™‚ä»»å‹™', needs.create-vm.outputs.time, needs.create-vm.outputs.creation_status == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—', needs.create-vm.outputs.attempt_count, needs.create-vm.outputs.creation_status == 'true' && 'VM å‰µå»ºæˆåŠŸ' || needs.create-vm.outputs.error_message, env.OCI_REGION, github.repository, github.run_id, needs.create-vm.outputs.creation_status == 'true' && format('
            <b>VM è³‡è¨Š</b>
            â€¢ <b>è™›æ“¬æ©Ÿå™¨åç¨±:</b> {0}
            â€¢ <b>å…¬ç¶² IP:</b> {1}', needs.create-vm.outputs.vm_name, needs.create-vm.outputs.public_ip) || '') }}
