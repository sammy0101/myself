name: '[Manual] Create OCI A1 Flex VM'

on:
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'Name of the VM instance'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OCI CLI
        run: |
          # å®‰è£… OCI CLI
          pip install oci-cli
          # éªŒè¯å®‰è£…
          oci --version

      - name: Generate cloud-init script for root login
        run: |
          # åˆ›å»º cloud-init é…ç½®è„šæœ¬ï¼Œå…è®¸ root å¯†ç ç™»å½•
          cat > cloud-init.txt << 'EOF'
          #cloud-config
          users:
            - name: root
              password: $ROOT_PASSWORD
              lock_passwd: false
          chpasswd:
            list: |
              root:$ROOT_PASSWORD
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
          EOF
          
          # æ›¿æ¢å¯†ç å ä½ç¬¦ä¸ºå®é™…å¯†ç 
          sed -i "s/\$ROOT_PASSWORD/${{ secrets.ROOT_PASSWORD }}/g" cloud-init.txt

      - name: Configure OCI CLI
        run: |
          # åˆ›å»º OCI é…ç½®
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          EOF
          
          # åˆ›å»º API å¯†é’¥æ–‡ä»¶
          cat > ~/.oci/oci_api_key.pem << EOF
          ${{ secrets.OCI_API_KEY }}
          EOF
          
          # è®¾ç½®æ–‡ä»¶æƒé™
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: Create A1 Flex VM Instance
        run: |
          # åˆ›å»º A1 Flex è§„æ ¼çš„è™šæ‹Ÿæœº
          oci compute instance launch \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
            --display-name "${{ github.event.inputs.vm-name }}" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
            --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
            --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
            --assign-public-ip true \
            --user-data-file ./cloud-init.txt

      - name: Wait for VM initialization (60 seconds)
        run: |
          echo "ç­‰å¾…è™šæ‹Ÿæœºåˆå§‹åŒ–å®Œæˆ..."
          sleep 60

      - name: Get VM Public IP
        id: get-ip
        run: |
          # è·å–è™šæ‹Ÿæœºå…¬ç½‘IP
          PUBLIC_IP=$(oci compute instance list \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --display-name "${{ github.event.inputs.vm-name }}" \
            --lifecycle-state RUNNING \
            --query 'data[0]."public-ip"' \
            --raw-output)
          
          echo "public_ip=${PUBLIC_IP}" >> $GITHUB_OUTPUT
          echo "VM Public IP: ${PUBLIC_IP}"

      - name: Print Connection Info
        run: |
          echo "ğŸ‰ VM instance '${{ github.event.inputs.vm-name }}' åˆ›å»ºæˆåŠŸ!"
          echo "ğŸ“Š é…ç½®: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"
          echo "ğŸ”‘ ç™»å½•ç”¨æˆ·: root"
          echo "ğŸ”’ å¯†ç : ä½¿ç”¨æ‚¨åœ¨ Secrets ä¸­è®¾ç½®çš„ ROOT_PASSWORD"
          echo "ğŸŒ è¿æ¥æ–¹å¼: ssh root@${{ steps.get-ip.outputs.public_ip }}"
          echo ""
          echo "âš ï¸  å®‰å…¨æç¤º: å¯†ç è®¤è¯å’Œ root ç™»å½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸æ¨èä½¿ç”¨"
