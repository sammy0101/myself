name: '[Manual] Create OCI VM'

on:
  # ç§»é™¤äº† push: è§¦å‘å™¨ï¼Œåªä¿ç•™ workflow_dispatch
  workflow_dispatch:
    # å¯é€‰ï¼šå®šä¹‰è¾“å…¥å‚æ•°ï¼Œè®©æ‰‹åŠ¨è§¦å‘æ—¶å¯ä»¥åŠ¨æ€é…ç½®
    inputs:
      vm-name:
        description: 'Name of the VM instance'
        required: true
        default: 'github-actions-vm'
        type: string
      vm-shape:
        description: 'Compute shape (e.g., VM.Standard.E2.1.Micro)'
        required: true
        default: 'VM.Standard.E2.1.Micro'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OCI CLI
        uses: oracle-actions/setup-oci-cli@v1

      - name: Create VM Instance
        env:
          OCI_TENANCY: ${{ secrets.OCI_TENANCY }}
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_API_KEY: ${{ secrets.OCI_API_KEY }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
          OCI_SUBNET_ID: ${{ secrets.OCI_SUBNET_ID }}
        run: |
          # ä½¿ç”¨ workflow_dispatch çš„è¾“å…¥å‚æ•°
          oci compute instance launch \
            --compartment-id $OCI_COMPARTMENT_ID \
            --availability-domain "Pllz:PHX-AD-1" \  # è¯·æ›¿æ¢ä¸ºä½ çš„å¯ç”¨æ€§åŸŸï¼ˆAvailability Domainï¼‰
            --display-name "${{ github.event.inputs.vm-name }}" \
            --shape "${{ github.event.inputs.vm-shape }}" \
            --image-id "ocid1.image.oc1.ap-osaka-1.aaaaaaaaglaxxdyc7fwf77e4lq26h2nhik52d2bmxjuiqe5mzndw3zpmj4hq" \  # è¯·æ›¿æ¢ä¸ºä½ çš„é•œåƒ OCIDï¼ˆä¾‹å¦‚ Oracle Linux çš„ OCIDï¼‰
            --subnet-id $OCI_SUBNET_ID \
            --assign-public-ip true \
            --ssh-authorized-keys-file ./public-key.txt  # ç¡®ä¿ä½ çš„å…¬é’¥æ–‡ä»¶åœ¨æ­¤è·¯å¾„

      - name: Get VM Public IP
        id: get-ip
        env:
          OCI_COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
        run: |
          # ç¨ç­‰ä¸€ä¼šå„¿ï¼Œè®©VMè·å–IPåœ°å€
          sleep 15
          # æŸ¥è¯¢å®ä¾‹çš„å…¬ç½‘IPï¼Œå¹¶è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          PUBLIC_IP=$(oci compute instance list \
            --compartment-id $OCI_COMPARTMENT_ID \
            --display-name "${{ github.event.inputs.vm-name }}" \
            --lifecycle-state RUNNING \
            --query 'data[0]."public-ip"' \
            --raw-output)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "VM Public IP: $PUBLIC_IP"

      - name: Print Connection Info
        run: |
          echo "ğŸ‰ VM instance '${{ github.event.inputs.vm-name }}' has been created successfully!"
          echo "ğŸŒ You can connect to it using: ssh opc@${{ steps.get-ip.outputs.public_ip }}"
          # å‡è®¾ä½ ä½¿ç”¨çš„æ˜¯ Oracle Linux æˆ– CentOSï¼Œé»˜è®¤ç”¨æˆ·æ˜¯ 'opc'
          # å¦‚æœæ˜¯ Ubuntuï¼Œé»˜è®¤ç”¨æˆ·æ˜¯ 'ubuntu'
