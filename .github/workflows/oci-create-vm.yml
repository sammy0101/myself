name: '[Scheduled] Create OCI A1 Flex VM'

on:
  schedule:
    # æ–¹æ¡ˆä¸€ (ç©©å¥å‹)ï¼šæ¯å¤© UTC æ™‚é–“æ—©ä¸Š 6 é»é‹è¡Œä¸€æ¬¡
    # - cron: '0 6 * * *'
    
    # æ–¹æ¡ˆäºŒ (ç©æ¥µå‹)ï¼šæ¯å¤© UTC æ™‚é–“ 0 é»å’Œ 12 é»å„é‹è¡Œä¸€æ¬¡
    - cron: '0 0,12 * * *'
    
  # ä¿ç•™æ‰‹å‹•è§¸ç™¼åŠŸèƒ½
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'è™›æ“¬æ©Ÿå™¨çš„åç¨±'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OCI CLI and network tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dnsutils jq
          pip install oci-cli
          oci --version

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          EOF
          
          cat > ~/.oci/oci_api_key.pem << EOF
          ${{ secrets.OCI_API_KEY }}
          EOF
          
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: Show current configuration and time
        run: |
          echo "ç›®å‰æ™‚é–“: $(date)"
          echo "ç›®å‰é…ç½®:"
          echo "å€åŸŸ: ${{ secrets.OCI_REGION }}"
          echo "å¯ç”¨æ€§ç¶²åŸŸ: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}"
          echo "å¯¦ä¾‹è¦æ ¼: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"

      - name: Generate cloud-init script for root login
        run: |
          cat > cloud-init.txt << 'EOF'
          #cloud-config
          users:
            - name: root
              password: $ROOT_PASSWORD
              lock_passwd: false
          chpasswd:
            list: |
              root:$ROOT_PASSWORD
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
          EOF
          
          sed -i "s/\$ROOT_PASSWORD/${{ secrets.ROOT_PASSWORD }}/g" cloud-init.txt

      - name: Create A1 Flex VM Instance with error handling
        id: create-vm
        run: |
          set +e  # å…è¨±å‘½ä»¤å¤±æ•—è€Œä¸ç«‹å³é€€å‡º
          
          max_retries=2
          retry_delay=30
          
          # å¦‚æœæ˜¯å®šæ™‚ä»»å‹™ï¼Œä½¿ç”¨å›ºå®šåç¨±ï¼›å¦‚æœæ˜¯æ‰‹å‹•è§¸ç™¼ï¼Œä½¿ç”¨è¼¸å…¥çš„åç¨±
          if [ -n "${{ github.event.inputs.vm-name }}" ]; then
            VM_NAME="${{ github.event.inputs.vm-name }}"
          else
            VM_NAME="scheduled-a1-vm-$(date +%Y%m%d)"
          fi
          
          for i in $(seq 1 $max_retries); do
            echo "å˜—è©¦ $i of $max_retries"
            
            # é‹è¡Œ OCI å‘½ä»¤ä¸¦æ•ç²è¼¸å‡º
            output=$(oci compute instance launch \
              --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
              --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
              --display-name "$VM_NAME" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
              --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
              --assign-public-ip true \
              --user-data-file ./cloud-init.txt 2>&1)
            
            exit_code=$?
            
            if [ $exit_code -eq 0 ]; then
              echo "âœ… è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
              break
            else
              echo "âŒ å˜—è©¦ $i å¤±æ•—ï¼Œé€€å‡ºç¢¼: $exit_code"
              echo "éŒ¯èª¤è¼¸å‡º: $output"
              
              # æª¢æŸ¥æ˜¯å¦æ˜¯å…è²»å¸³æˆ¶è³‡æºä¸è¶³
              if echo "$output" | grep -i "out of host capacity\|insufficientcapacity\|outofcapacity"; then
                echo "free_tier_limit=true" >> $GITHUB_OUTPUT
                echo "error_type=free_tier_limit" >> $GITHUB_OUTPUT
                echo "error_message=å…è²»å¸³æˆ¶è³‡æºé™åˆ¶: ç›®å‰å€åŸŸæˆ–å¯ç”¨æ€§ç¶²åŸŸä¸­æ²’æœ‰è¶³å¤ çš„è³‡æºä¾†å»ºç«‹è™›æ“¬æ©Ÿå™¨" >> $GITHUB_OUTPUT
              elif echo "$output" | grep -i "quota\|limit\|notavailable\|free tier\|insufficient"; then
                echo "free_tier_limit=true" >> $GITHUB_OUTPUT
                echo "error_type=free_tier_limit" >> $GITHUB_OUTPUT
                echo "error_message=å…è²»å¸³æˆ¶è³‡æºé™åˆ¶ï¼Œå¯èƒ½å€åŸŸè³‡æºä¸è¶³æˆ–å·²é”å…è²»é¡åº¦ä¸Šé™" >> $GITHUB_OUTPUT
              elif echo "$output" | grep -i "timeout\|connection"; then
                echo "error_type=network_timeout" >> $GITHUB_OUTPUT
                echo "error_message=ç¶²è·¯é€£æ¥è¶…æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦" >> $GITHUB_OUTPUT
              else
                echo "error_type=other" >> $GITHUB_OUTPUT
                echo "error_message=å…¶ä»–éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é…ç½®å’Œæ¬Šé™" >> $GITHUB_OUTPUT
              fi
              
              if [ $i -eq $max_retries ]; then
                echo "æ‰€æœ‰å˜—è©¦éƒ½å¤±æ•—äº†ã€‚"
                break
              fi
              
              echo "ç­‰å¾… $retry_delay ç§’å¾Œé‡è©¦..."
              sleep $retry_delay
            fi
          done
          
          set -e  # æ¢å¾©éŒ¯èª¤é€€å‡º

      - name: Wait for VM initialization
        if: steps.create-vm.outputs.success == 'true'
        run: |
          echo "ç­‰å¾…è™›æ“¬æ©Ÿå™¨åˆå§‹åŒ–å®Œæˆ..."
          sleep 60

      - name: Get VM Public IP
        if: steps.create-vm.outputs.success == 'true'
        id: get-ip
        run: |
          PUBLIC_IP=$(oci compute instance list \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --display-name "${{ steps.create-vm.outputs.vm_name }}" \
            --lifecycle-state RUNNING \
            --query 'data[0]."public-ip"' \
            --raw-output)
          
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" == "null" ]; then
            echo "âŒ ç„¡æ³•å–å¾—è™›æ“¬æ©Ÿå™¨å…¬ç¶²IP"
            echo "é€™å¯èƒ½æ˜¯å› ç‚º:"
            echo "1. è™›æ“¬æ©Ÿå™¨æ²’æœ‰åˆ†é…å…¬ç¶²IP"
            echo "2. è™›æ“¬æ©Ÿå™¨æ²’æœ‰æˆåŠŸå•Ÿå‹•"
            echo "public_ip=unknown" >> $GITHUB_OUTPUT
          else
            echo "public_ip=${PUBLIC_IP}" >> $GITHUB_OUTPUT
            echo "è™›æ“¬æ©Ÿå™¨å…¬ç¶² IP: ${PUBLIC_IP}"
          fi

      - name: Prepare Telegram notification message
        id: prepare-telegram-message
        run: |
          # æº–å‚™ Telegram è¨Šæ¯å…§å®¹
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            MESSAGE="âœ… OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ
            â€¢ åç¨±: ${{ steps.create-vm.outputs.vm_name }}
            â€¢ IP: ${{ steps.get-ip.outputs.public_ip }}
            â€¢ é…ç½®: A1.Flex (4 OCPU, 24GB RAM)
            â€¢ æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S UTC')
            â€¢ ç™»å…¥: ssh root@${{ steps.get-ip.outputs.public_ip }}"
          else
            MESSAGE="âŒ OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹å¤±æ•—
            â€¢ éŒ¯èª¤: ${{ steps.create-vm.outputs.error_message }}
            â€¢ æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S UTC')
            â€¢ å€åŸŸ: ${{ secrets.OCI_REGION }}
            â€¢ è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          # ç§»é™¤å¤šé¤˜ç¸®é€²ä¸¦å„²å­˜è¨Šæ¯
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" | sed 's/^            //g' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.prepare-telegram-message.outputs.message }}
          format: html

      - name: Handle VM creation result
        if: always()
        run: |
          # æª¢æŸ¥ä¸Šä¸€æ­¥çš„çµæœ
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            echo "ğŸ‰ è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ!"
            echo "è™›æ“¬æ©Ÿå™¨åç¨±: ${{ steps.create-vm.outputs.vm_name }}"
            echo "æ­£åœ¨ç­‰å¾…è™›æ“¬æ©Ÿå™¨åˆå§‹åŒ–..."
          else
            echo "âŒ è™›æ“¬æ©Ÿå™¨å»ºç«‹å¤±æ•—"
            echo "éŒ¯èª¤é¡å‹: ${{ steps.create-vm.outputs.error_type }}"
            echo "éŒ¯èª¤è¨Šæ¯: ${{ steps.create-vm.outputs.error_message }}"
            
            # å¦‚æœæ˜¯å…è²»å¸³æˆ¶è³‡æºä¸è¶³ï¼Œæä¾›æ›´å¤šå»ºè­°
            if [[ "${{ steps.create-vm.outputs.free_tier_limit }}" == "true" ]]; then
              echo ""
              echo "ğŸ’¡ Oracle Cloud å…è²»å¸³æˆ¶å»ºç«‹è™›æ“¬æ©Ÿå™¨å¤±æ•—å»ºè­°:"
              echo "1. å˜—è©¦ä½¿ç”¨ä¸åŒçš„å¯ç”¨æ€§ç¶²åŸŸ (Availability Domain)"
              echo "   - ç›®å‰å¯ç”¨æ€§ç¶²åŸŸ: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}"
              echo "   - æ‚¨å¯ä»¥åœ¨ OCI æ§åˆ¶å°ä¸­æŸ¥çœ‹å…¶ä»–å¯ç”¨æ€§ç¶²åŸŸ"
              echo "2. ç¨å¾Œé‡è©¦ (å¹¾å°æ™‚æˆ–ç¬¬äºŒå¤©)ï¼Œå…è²»å±¤è³‡æºå¯èƒ½æœƒéš¨æ™‚é–“é‡‹æ”¾"
              echo "3. è€ƒæ…®ä½¿ç”¨ä¸åŒçš„å€åŸŸ (Region)"
              echo "   - ç›®å‰å€åŸŸ: ${{ secrets.OCI_REGION }}"
              echo "   - ä¸€äº›è¼ƒå°‘äººä½¿ç”¨çš„å€åŸŸå¯èƒ½æœ‰æ›´å¤šå¯ç”¨è³‡æº"
              echo "4. å˜—è©¦å»ºç«‹è¼ƒå°é…ç½®çš„å¯¦ä¾‹ (å¦‚ 1 OCPU, 6GB RAM)"
              echo "5. å…è²»å¸³æˆ¶æœ‰æ™‚åœ¨æŸäº›å€åŸŸ/æ™‚é–“æ®µçš„è³‡æºç¢ºå¯¦å¾ˆç·Šå¼µï¼Œéœ€è¦è€å¿ƒå˜—è©¦"
              echo ""
              echo "â„¹ï¸  é€™æ˜¯ä¸€å€‹å¸¸è¦‹çš„å…è²»å¸³æˆ¶å•é¡Œï¼Œä¸æ˜¯æ‚¨çš„é…ç½®éŒ¯èª¤ã€‚"
            fi
            
            # å¦‚æœä¸æ˜¯å…è²»å¸³æˆ¶é™åˆ¶ï¼Œå¯èƒ½æ˜¯å…¶ä»–éŒ¯èª¤
            if [[ "${{ steps.create-vm.outputs.error_type }}" == "network_timeout" ]]; then
              echo ""
              echo "ğŸ’¡ ç¶²è·¯è¶…æ™‚å»ºè­°:"
              echo "1. ç¨å¾Œé‡è©¦ï¼Œå¯èƒ½æ˜¯è‡¨æ™‚ç¶²è·¯å•é¡Œ"
              echo "2. æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£æ¥"
            fi
            
            # é€€å‡ºå·¥ä½œæµä¸¦æ¨™è¨˜ç‚ºå¤±æ•—
            exit 1
          fi

      - name: Print Success Message
        if: steps.create-vm.outputs.success == 'true'
        run: |
          echo "ğŸ‰ è™›æ“¬æ©Ÿå™¨ '${{ steps.create-vm.outputs.vm_name }}' å»ºç«‹æˆåŠŸ!"
          echo "ğŸ“Š é…ç½®: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"
          echo "ğŸ”‘ ç™»å…¥ç”¨æˆ¶: root"
          echo "ğŸ”’ å¯†ç¢¼: ä½¿ç”¨æ‚¨åœ¨ Secrets ä¸­è¨­å®šçš„ ROOT_PASSWORD"
          echo "ğŸŒ é€£æ¥æ–¹å¼: ssh root@${{ steps.get-ip.outputs.public_ip }}"
          echo ""
          echo "âš ï¸  å®‰å…¨æç¤º: å¯†ç¢¼èªè­‰å’Œ root ç™»å…¥åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä¸æ¨è–¦ä½¿ç”¨"

      - name: Print Final Result
        if: always()
        run: |
          echo "=== åŸ·è¡Œçµæœå½™ç¸½ ==="
          echo "åŸ·è¡Œæ™‚é–“: $(date)"
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            echo "âœ… å·¥ä½œæµåŸ·è¡ŒæˆåŠŸ: è™›æ“¬æ©Ÿå™¨å·²å»ºç«‹ä¸¦é…ç½®å®Œæˆ"
            echo "è™›æ“¬æ©Ÿå™¨åç¨±: ${{ steps.create-vm.outputs.vm_name }}"
            echo "å…¬ç¶² IP: ${{ steps.get-ip.outputs.public_ip }}"
          else
            echo "âŒ å·¥ä½œæµåŸ·è¡Œå¤±æ•—: è™›æ“¬æ©Ÿå™¨å»ºç«‹æœªæˆåŠŸ"
            echo "éŒ¯èª¤é¡å‹: ${{ steps.create-vm.outputs.error_type }}"
            echo "è«‹æŸ¥çœ‹ä¸Šè¿°éŒ¯èª¤è¨Šæ¯å’Œå»ºè­°"
          fi
