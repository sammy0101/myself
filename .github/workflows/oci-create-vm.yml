name: '[Scheduled] Create OCI A1 Flex VM'

on:
  # æ¯å¤© UTC æ™‚é–“ 0 é»å’Œ 12 é»å„é‹è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 0,12 * * *'
  # ä¿ç•™æ‰‹å‹•è§¸ç™¼åŠŸèƒ½
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'è™›æ“¬æ©Ÿå™¨çš„åç¨±'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: è¨­ç½® Python å’Œ OCI CLI
        run: |
          # æª¢æŸ¥ Python ç‰ˆæœ¬ (OCI CLI éœ€è¦ Python 3.6+)
          echo "ç›®å‰ Python ç‰ˆæœ¬: $(python3 --version)"
          python3 -c "import sys; assert sys.version_info >= (3, 6), 'Python 3.6+ required'; print('âœ… Python ç‰ˆæœ¬ç¬¦åˆè¦æ±‚')"
          
          # å®‰è£æŒ‡å®šç‰ˆæœ¬çš„ OCI CLI (ä½¿ç”¨æœ€æ–°ç©©å®šç‰ˆ)
          pip install oci-cli==3.64.1 --user
          
          # å°‡ä½¿ç”¨è€…ç«™é»åŒ…æ·»åŠ åˆ° PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # é©—è­‰å®‰è£
          oci --version
          echo "âœ… OCI CLI ç‰ˆæœ¬: $(oci --version)"

      - name: å®‰è£é¡å¤–ä¾è³´
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dnsutils jq ssh-client

      - name: é…ç½® OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          EOF
          
          cat > ~/.oci/oci_api_key.pem << EOF
          ${{ secrets.OCI_API_KEY }}
          EOF
          
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: é¡¯ç¤ºç•¶å‰é…ç½®
        run: |
          echo "ç›®å‰æ™‚é–“: $(date)"
          echo "ç›®å‰é…ç½®:"
          echo "å€åŸŸ: ${{ secrets.OCI_REGION }}"
          echo "å¯ç”¨æ€§ç¶²åŸŸ: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}"
          echo "å¯¦ä¾‹è¦æ ¼: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"
          echo "OCI CLI ç‰ˆæœ¬: $(oci --version)"

      - name: ç”Ÿæˆ cloud-init è…³æœ¬ç”¨æ–¼ root ç™»å…¥
        run: |
          cat > cloud-init.txt << 'EOF'
          #cloud-config
          users:
            - name: root
              password: $ROOT_PASSWORD
              lock_passwd: false
          chpasswd:
            list: |
              root:$ROOT_PASSWORD
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
            - apt-get update && apt-get install -y openssh-server
          EOF
          
          sed -i "s/\$ROOT_PASSWORD/${{ secrets.ROOT_PASSWORD }}/g" cloud-init.txt

      - name: å‰µå»º A1 Flex è™›æ“¬æ©Ÿå™¨å¯¦ä¾‹ (2æ¬¡å˜—è©¦)
        id: create-vm
        continue-on-error: true  # å³ä½¿æ­¤æ­¥é©Ÿå¤±æ•—ï¼Œä¹Ÿç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæ­¥é©Ÿ
        run: |
          set +e  # å…è¨±å‘½ä»¤å¤±æ•—è€Œä¸ç«‹å³é€€å‡º
          
          # é‡è©¦åƒæ•¸é…ç½® - æœ€å¤šé‡è©¦1æ¬¡ï¼ˆå…±2æ¬¡å˜—è©¦ï¼‰
          max_retries=1           # æœ€å¤šé‡è©¦1æ¬¡ï¼ˆå…±2æ¬¡å˜—è©¦ï¼‰
          retry_delay=300         # æ¯æ¬¡é‡è©¦å»¶é²300ç§’ï¼ˆ5åˆ†é˜ï¼‰
          total_attempts=0
          all_errors=""
          
          # æ±ºå®šè™›æ“¬æ©Ÿå™¨åç¨±
          if [ -n "${{ github.event.inputs.vm-name }}" ]; then
            VM_NAME="${{ github.event.inputs.vm-name }}"
          else
            VM_NAME="scheduled-a1-vm-$(date +%Y%m%d-%H%M)"
          fi
          
          echo "é–‹å§‹å»ºç«‹è™›æ“¬æ©Ÿå™¨: $VM_NAME"
          echo "ç­–ç•¥: 2æ¬¡å˜—è©¦ï¼Œæ¯æ¬¡å»¶é² $retry_delay ç§’"
          
          for attempt in $(seq 0 $max_retries); do
            total_attempts=$((attempt + 1))
            echo "--- å˜—è©¦ç¬¬ $total_attempts æ¬¡å»ºç«‹ ---"
            
            # åŸ·è¡Œ OCI å‘½ä»¤å»ºç«‹è™›æ“¬æ©Ÿå™¨ï¼Œä¸¦æ•ç² JSON è¼¸å‡º
            output=$(oci compute instance launch \
              --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
              --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
              --display-name "$VM_NAME" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
              --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
              --assign-public-ip true \
              --user-data-file ./cloud-init.txt \
              --output json 2>&1)
            
            exit_code=$?
            
            if [ $exit_code -eq 0 ]; then
              # å¾ JSON è¼¸å‡ºä¸­æå–å¯¦ä¾‹ OCID
              INSTANCE_OCID=$(echo "$output" | jq -r '.data.id')
              
              if [ -n "$INSTANCE_OCID" ] && [ "$INSTANCE_OCID" != "null" ]; then
                echo "âœ… è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ (ç¬¬ $total_attempts æ¬¡å˜—è©¦)"
                echo "success=true" >> $GITHUB_OUTPUT
                echo "vm_name=$VM_NAME" >> $GITHUB_OUTPUT
                echo "instance_ocid=$INSTANCE_OCID" >> $GITHUB_OUTPUT
                echo "attempt_count=$total_attempts" >> $GITHUB_OUTPUT
                echo "Instance OCID: $INSTANCE_OCID"
                
                # æå–æˆåŠŸè¨Šæ¯
                success_msg=$(echo "$output" | jq -r '.message // "è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ"' 2>/dev/null || echo "è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ")
                echo "success_message=$success_msg" >> $GITHUB_OUTPUT
                break
              else
                echo "âŒ ç„¡æ³•å¾è¼¸å‡ºä¸­è§£æ Instance OCID"
                echo "output: $output"
                error_msg="ç„¡æ³•å¾OCIå›æ‡‰ä¸­è§£æå¯¦ä¾‹ID"
                all_errors="$all_errorså˜—è©¦ $total_attempts: $error_msg; "
              fi
            else
              echo "âŒ ç¬¬ $total_attempts æ¬¡å˜—è©¦å¤±æ•—ï¼Œé€€å‡ºç¢¼: $exit_code"
              echo "éŒ¯èª¤è¼¸å‡º: $output"
              
              # æå–éŒ¯èª¤è¨Šæ¯
              error_msg=$(echo "$output" | grep -o '"message": "[^"]*"' | head -1 | cut -d'"' -f4 || echo "æœªçŸ¥éŒ¯èª¤")
              echo "æå–çš„éŒ¯èª¤è¨Šæ¯: $error_msg"
              all_errors="$all_errorså˜—è©¦ $total_attempts: $error_msg; "
              
              # æª¢æŸ¥éŒ¯èª¤é¡å‹
              if echo "$output" | grep -Ei "out of host capacity|insufficientcapacity|outofcapacity|service limit exceeded|limit exceeded|capacity not available|not available|host capacity"; then
                error_type="capacity_error"
              elif echo "$output" | grep -Ei "quota|limit|notavailable|free tier|insufficient|over quota"; then
                error_type="quota_error"
                break  # é…é¡éŒ¯èª¤é‡è©¦ç„¡æ„ç¾©
              elif echo "$output" | grep -Ei "timeout|connection|request timed out"; then
                error_type="network_error"
              elif echo "$output" | grep -Ei "TooManyRequests|Too many requests"; then
                error_type="too_many_requests"
              else
                error_type="other_error"
              fi
              
              # å„²å­˜éŒ¯èª¤è³‡è¨Š
              echo "free_tier_limit=true" >> $GITHUB_OUTPUT
              echo "error_type=$error_type" >> $GITHUB_OUTPUT
              
              # è™•ç†éŒ¯èª¤è¨Šæ¯ï¼Œé¿å…æ ¼å¼å•é¡Œ
              safe_error_msg=$(echo "$error_msg" | head -n 1 | sed 's/[{}]//g' | cut -c 1-200)
              echo "error_message=$safe_error_msg" >> $GITHUB_OUTPUT
            fi
            
            # å¦‚æœæ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œä¸å†å»¶é²
            if [ $attempt -eq $max_retries ]; then
              echo "å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ ($max_retries æ¬¡)ï¼Œåœæ­¢é‡è©¦"
              echo "success=false" >> $GITHUB_OUTPUT
              echo "attempt_count=$total_attempts" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "ç­‰å¾… $retry_delay ç§’å¾Œé‡è©¦..."
            sleep $retry_delay
          done
          
          # å„²å­˜æ‰€æœ‰éŒ¯èª¤è¨Šæ¯
          echo "all_errors=$all_errors" >> $GITHUB_OUTPUT
          
          # æ¢å¾©éŒ¯èª¤è™•ç†
          set -e

      - name: ç™¼é€ç¬¬ä¸€æ¬¡ Telegram é€šçŸ¥
        id: send-telegram-attempt-1
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ format('{0} OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹å˜—è©¦é€šçŸ¥', github.event_name) }}
            â€¢ æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S UTC')
            â€¢ å˜—è©¦: ç¬¬ 1 æ¬¡
            â€¢ ç‹€æ…‹: ${{ steps.create-vm.outputs.success == 'true' && 'æˆåŠŸ' || 'å¤±æ•—' }}
            â€¢ è¨Šæ¯: ${{ steps.create-vm.outputs.success == 'true' && steps.create-vm.outputs.success_message || steps.create-vm.outputs.error_message }}
            â€¢ å€åŸŸ: ${{ secrets.OCI_REGION }}
          format: html

      - name: ç­‰å¾…ç¬¬äºŒæ¬¡å˜—è©¦
        if: steps.create-vm.outputs.success != 'true' && steps.create-vm.outputs.attempt_count == 1
        run: |
          echo "ç­‰å¾… 300 ç§’å¾Œé€²è¡Œç¬¬äºŒæ¬¡å˜—è©¦..."
          sleep 300

      - name: ç¬¬äºŒæ¬¡å˜—è©¦å»ºç«‹è™›æ“¬æ©Ÿå™¨
        id: create-vm-attempt-2
        if: steps.create-vm.outputs.success != 'true' && steps.create-vm.outputs.attempt_count == 1
        continue-on-error: true
        run: |
          set +e
          
          echo "--- å˜—è©¦ç¬¬ 2 æ¬¡å»ºç«‹ ---"
          
          # åŸ·è¡Œ OCI å‘½ä»¤å»ºç«‹è™›æ“¬æ©Ÿå™¨ï¼Œä¸¦æ•ç² JSON è¼¸å‡º
          output=$(oci compute instance launch \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
            --display-name "${{ steps.create-vm.outputs.vm_name }}" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
            --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
            --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
            --assign-public-ip true \
            --user-data-file ./cloud-init.txt \
            --output json 2>&1)
          
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            # å¾ JSON è¼¸å‡ºä¸­æå–å¯¦ä¾‹ OCID
            INSTANCE_OCID=$(echo "$output" | jq -r '.data.id')
            
            if [ -n "$INSTANCE_OCID" ] && [ "$INSTANCE_OCID" != "null" ]; then
              echo "âœ… è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ (ç¬¬ 2 æ¬¡å˜—è©¦)"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "instance_ocid=$INSTANCE_OCID" >> $GITHUB_OUTPUT
              echo "attempt_count=2" >> $GITHUB_OUTPUT
              echo "Instance OCID: $INSTANCE_OCID"
              
              # æå–æˆåŠŸè¨Šæ¯
              success_msg=$(echo "$output" | jq -r '.message // "è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ"' 2>/dev/null || echo "è™›æ“¬æ©Ÿå™¨å»ºç«‹æˆåŠŸ")
              echo "success_message=$success_msg" >> $GITHUB_OUTPUT
            else
              echo "âŒ ç„¡æ³•å¾è¼¸å‡ºä¸­è§£æ Instance OCID"
              echo "output: $output"
              echo "success=false" >> $GITHUB_OUTPUT
              echo "attempt_count=2" >> $GITHUB_OUTPUT
              
              # æå–éŒ¯èª¤è¨Šæ¯
              error_msg=$(echo "$output" | grep -o '"message": "[^"]*"' | head -1 | cut -d'"' -f4 || echo "æœªçŸ¥éŒ¯èª¤")
              echo "error_message=$error_msg" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ ç¬¬ 2 æ¬¡å˜—è©¦å¤±æ•—ï¼Œé€€å‡ºç¢¼: $exit_code"
            echo "éŒ¯èª¤è¼¸å‡º: $output"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "attempt_count=2" >> $GITHUB_OUTPUT
            
            # æå–éŒ¯èª¤è¨Šæ¯
            error_msg=$(echo "$output" | grep -o '"message": "[^"]*"' | head -1 | cut -d'"' -f4 || echo "æœªçŸ¥éŒ¯èª¤")
            echo "error_message=$error_msg" >> $GITHUB_OUTPUT
          fi
          
          set -e

      - name: ç™¼é€ç¬¬äºŒæ¬¡ Telegram é€šçŸ¥
        id: send-telegram-attempt-2
        if: always() && steps.create-vm-attempt-2
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ format('{0} OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹å˜—è©¦é€šçŸ¥', github.event_name) }}
            â€¢ æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S UTC')
            â€¢ å˜—è©¦: ç¬¬ 2 æ¬¡
            â€¢ ç‹€æ…‹: ${{ steps.create-vm-attempt-2.outputs.success == 'true' && 'æˆåŠŸ' || 'å¤±æ•—' }}
            â€¢ è¨Šæ¯: ${{ steps.create-vm-attempt-2.outputs.success == 'true' && steps.create-vm-attempt-2.outputs.success_message || steps.create-vm-attempt-2.outputs.error_message }}
            â€¢ å€åŸŸ: ${{ secrets.OCI_REGION }}
          format: html

      - name: ç­‰å¾…å¯¦ä¾‹é”åˆ° RUNNING ç‹€æ…‹
        if: (steps.create-vm.outputs.success == 'true' || steps.create-vm-attempt-2.outputs.success == 'true') && (steps.create-vm.outputs.instance_ocid || steps.create-vm-attempt-2.outputs.instance_ocid)
        id: wait-for-running
        continue-on-error: true
        run: |
          INSTANCE_OCID="${{ steps.create-vm.outputs.instance_ocid || steps.create-vm-attempt-2.outputs.instance_ocid }}"
          echo "ç­‰å¾…å¯¦ä¾‹ $INSTANCE_OCID é€²å…¥ RUNNING ç‹€æ…‹..."
          
          # è¨­ç½®è¼ªè©¢åƒæ•¸ï¼ˆå»¶é•·åˆ°10åˆ†é˜ï¼‰
          MAX_ATTEMPTS=60  # æœ€å¤šå˜—è©¦60æ¬¡ (10åˆ†é˜)
          SLEEP_INTERVAL=10  # æ¯æ¬¡é–“éš”10ç§’
          attempt=1
          
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            # ä½¿ç”¨ç²¾ç¢ºçš„å¯¦ä¾‹OCIDæŸ¥è©¢ç•¶å‰ç‹€æ…‹
            CURRENT_STATE=$(oci compute instance get \
              --instance-id "$INSTANCE_OCID" \
              --query 'data."lifecycle-state"' \
              --raw-output 2>/dev/null || echo "UNKNOWN")
            
            echo "ç‹€æ…‹æª¢æŸ¥ $attempt/$MAX_ATTEMPTS: ç•¶å‰ç‹€æ…‹ç‚º '$CURRENT_STATE'"
            
            if [ "$CURRENT_STATE" = "RUNNING" ]; then
              echo "âœ… å¯¦ä¾‹ç¾åœ¨è™•æ–¼ RUNNING ç‹€æ…‹"
              echo "running=true" >> $GITHUB_OUTPUT
              break
            fi
            
            if [ $attempt -eq $MAX_ATTEMPTS ]; then
              echo "âŒ å¯¦ä¾‹æœªåœ¨è¶…æ™‚æ™‚é–“å…§é”åˆ° RUNNING ç‹€æ…‹"
              echo "running=false" >> $GITHUB_OUTPUT
              break
            fi
            
            sleep $SLEEP_INTERVAL
            ((attempt++))
          done

      - name: ç²å–è™›æ“¬æ©Ÿå™¨å…¬ç¶² IP (ç²¾ç¢ºæŸ¥è©¢)
        if: (steps.create-vm.outputs.success == 'true' || steps.create-vm-attempt-2.outputs.success == 'true') && steps.wait-for-running.outputs.running == 'true'
        id: get-ip
        continue-on-error: true
        run: |
          INSTANCE_OCID="${{ steps.create-vm.outputs.instance_ocid || steps.create-vm-attempt-2.outputs.instance_ocid }}"
          echo "ç²å–å¯¦ä¾‹çš„å…¬ç¶² IP: $INSTANCE_OCID"
          
          # ä½¿ç”¨ç²¾ç¢ºçš„å¯¦ä¾‹OCIDæŸ¥è©¢å…¬ç¶²IP
          PUBLIC_IP=$(oci compute instance get \
            --instance-id "$INSTANCE_OCID" \
            --query 'data."public-ip"' \
            --raw-output)
          
          # æª¢æŸ¥ç²å–åˆ°çš„IPæ˜¯å¦æœ‰æ•ˆ
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" = "null" ]; then
            echo "âŒ ç„¡æ³•ç²å–æœ‰æ•ˆçš„å…¬ç¶²IPåœ°å€ã€‚å¯èƒ½å°šæœªåˆ†é…ã€‚"
            echo "public_ip=unknown" >> $GITHUB_OUTPUT
          else
            echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
            echo "âœ… è™›æ“¬æ©Ÿå™¨å…¬ç¶² IP: $PUBLIC_IP"
          fi

      - name: ç™¼é€æœ€çµ‚çµæœ Telegram é€šçŸ¥
        id: send-telegram-final
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ format('{0} OCI è™›æ“¬æ©Ÿå™¨å»ºç«‹æœ€çµ‚çµæœ', github.event_name) }}
            â€¢ æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S UTC')
            â€¢ ç‹€æ…‹: ${{ (steps.create-vm.outputs.success == 'true' || steps.create-vm-attempt-2.outputs.success == 'true') && 'æˆåŠŸ' || 'å¤±æ•—' }}
            â€¢ å˜—è©¦æ¬¡æ•¸: ${{ steps.create-vm.outputs.attempt_count || steps.create-vm-attempt-2.outputs.attempt_count }}
            â€¢ è¨Šæ¯: ${{ (steps.create-vm.outputs.success == 'true' || steps.create-vm-attempt-2.outputs.success == 'true') && (steps.create-vm.outputs.success_message || steps.create-vm-attempt-2.outputs.success_message) || (steps.create-vm.outputs.error_message || steps.create-vm-attempt-2.outputs.error_message) }}
            â€¢ å€åŸŸ: ${{ secrets.OCI_REGION }}
            â€¢ è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          format: html

      - name: è™•ç†æœ€çµ‚çµæœ
        if: always()
        run: |
          echo "=== åŸ·è¡Œçµæœå½™ç¸½ ==="
          echo "åŸ·è¡Œæ™‚é–“: $(date)"
          echo "åŸ·è¡Œæ¨¡å¼: ${{ github.event_name }}"
          
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" || "${{ steps.create-vm-attempt-2.outputs.success }}" == "true" ]]; then
            if [[ "${{ steps.wait-for-running.outputs.running }}" == "true" ]]; then
              echo "âœ… å·¥ä½œæµåŸ·è¡ŒæˆåŠŸ: è™›æ“¬æ©Ÿå™¨å·²å»ºç«‹ä¸¦é…ç½®"
              echo "è™›æ“¬æ©Ÿå™¨åç¨±: ${{ steps.create-vm.outputs.vm_name }}"
              echo "å…¬ç¶² IP: ${{ steps.get-ip.outputs.public_ip }}"
              echo "å˜—è©¦æ¬¡æ•¸: ${{ steps.create-vm.outputs.attempt_count || steps.create-vm-attempt-2.outputs.attempt_count }}"
            else
              echo "âš ï¸  è™›æ“¬æ©Ÿå™¨å·²å»ºç«‹ä½†æœªé”åˆ° RUNNING ç‹€æ…‹"
              echo "è™›æ“¬æ©Ÿå™¨ OCID: ${{ steps.create-vm.outputs.instance_ocid || steps.create-vm-attempt-2.outputs.instance_ocid }}"
              echo "è«‹ç¨å¾Œåœ¨ OCI æ§åˆ¶å°ä¸­æª¢æŸ¥ç‹€æ…‹"
            fi
          else
            echo "âŒ å·¥ä½œæµåŸ·è¡Œå¤±æ•—: è™›æ“¬æ©Ÿå™¨å»ºç«‹æœªæˆåŠŸ"
            echo "å˜—è©¦æ¬¡æ•¸: ${{ steps.create-vm.outputs.attempt_count || steps.create-vm-attempt-2.outputs.attempt_count }}"
            echo "éŒ¯èª¤è¨Šæ¯: ${{ steps.create-vm.outputs.error_message || steps.create-vm-attempt-2.outputs.error_message }}"
            
            # å…è²»å¸³æˆ¶è³‡æºé™åˆ¶çš„ç‰¹æ®Šæç¤º
            if [[ "${{ steps.create-vm.outputs.free_tier_limit }}" == "true" ]]; then
              echo ""
              echo "ğŸ’¡ Oracle Cloud å…è²»å¸³æˆ¶å»ºç«‹è™›æ“¬æ©Ÿå™¨å¤±æ•—å»ºè­°:"
              echo "1. å˜—è©¦ä½¿ç”¨ä¸åŒçš„å¯ç”¨æ€§ç¶²åŸŸ"
              echo "2. ç¨å¾Œé‡è©¦ (å¹¾å°æ™‚æˆ–ç¬¬äºŒå¤©)"
              echo "3. è€ƒæ…®ä½¿ç”¨ä¸åŒçš„å€åŸŸ"
              echo "4. å˜—è©¦å»ºç«‹è¼ƒå°é…ç½®çš„å¯¦ä¾‹"
            fi
          fi
