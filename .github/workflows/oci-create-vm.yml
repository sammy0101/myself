name: '[Manual] Create OCI A1 Flex VM'

on:
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'Name of the VM instance'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install OCI CLI and network tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dnsutils jq  # æ·»åŠ  jq ç”¨äº JSON è§£æ
          pip install oci-cli
          oci --version

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          key_file=~/.oci/oci_api_key.pem
          tenancy=${{ secrets.OCI_TENANCY }}
          region=${{ secrets.OCI_REGION }}
          EOF
          
          cat > ~/.oci/oci_api_key.pem << EOF
          ${{ secrets.OCI_API_KEY }}
          EOF
          
          chmod 600 ~/.oci/config ~/.oci/oci_api_key.pem

      - name: Validate OCI Configuration
        run: |
          echo "Testing OCI configuration..."
          oci iam compartment get --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}"
          echo "âœ… Compartment access verified"

      - name: Generate cloud-init script for root login
        run: |
          cat > cloud-init.txt << 'EOF'
          #cloud-config
          users:
            - name: root
              password: $ROOT_PASSWORD
              lock_passwd: false
          chpasswd:
            list: |
              root:$ROOT_PASSWORD
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
          EOF
          
          sed -i "s/\$ROOT_PASSWORD/${{ secrets.ROOT_PASSWORD }}/g" cloud-init.txt

      - name: Create A1 Flex VM Instance with error handling
        id: create-vm
        run: |
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥è€Œä¸ç«‹å³é€€å‡º
          
          max_retries=2
          retry_delay=30
          
          for i in $(seq 1 $max_retries); do
            echo "Attempt $i of $max_retries"
            
            # è¿è¡Œ OCI å‘½ä»¤å¹¶æ•è·è¾“å‡º
            output=$(oci compute instance launch \
              --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
              --availability-domain "${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
              --display-name "${{ github.event.inputs.vm-name }}" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "${{ secrets.OCI_IMAGE_OCID }}" \
              --subnet-id "${{ secrets.OCI_SUBNET_ID }}" \
              --assign-public-ip true \
              --user-data-file ./cloud-init.txt 2>&1)
            
            exit_code=$?
            
            if [ $exit_code -eq 0 ]; then
              echo "âœ… VM creation successful"
              echo "success=true" >> $GITHUB_OUTPUT
              break
            else
              echo "âŒ Attempt $i failed with exit code: $exit_code"
              echo "Error output: $output"
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯å…è´¹è´¦æˆ·é™åˆ¶
              if echo "$output" | grep -i "quota\|limit\|outofcapacity\|notavailable\|free tier\|insufficient"; then
                echo "free_tier_limit=true" >> $GITHUB_OUTPUT
                echo "error_type=free_tier_limit" >> $GITHUB_OUTPUT
                echo "error_message=å…è´¹è´¦æˆ·èµ„æºé™åˆ¶ï¼Œå¯èƒ½åŒºåŸŸèµ„æºä¸è¶³æˆ–å·²è¾¾å…è´¹é¢åº¦ä¸Šé™" >> $GITHUB_OUTPUT
              elif echo "$output" | grep -i "timeout\|connection"; then
                echo "error_type=network_timeout" >> $GITHUB_OUTPUT
                echo "error_message=ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•" >> $GITHUB_OUTPUT
              else
                echo "error_type=other" >> $GITHUB_OUTPUT
                echo "error_message=å…¶ä»–é”™è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œæƒé™" >> $GITHUB_OUTPUT
              fi
              
              if [ $i -eq $max_retries ]; then
                echo "All attempts failed."
                break
              fi
              
              echo "Waiting $retry_delay seconds before retry..."
              sleep $retry_delay
            fi
          done
          
          set -e  # æ¢å¤é”™è¯¯é€€å‡º

      - name: Handle VM creation result
        if: always()
        run: |
          # æ£€æŸ¥ä¸Šä¸€æ­¥çš„ç»“æœ
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            echo "ğŸ‰ è™šæ‹Ÿæœºåˆ›å»ºæˆåŠŸ!"
            echo "æ­£åœ¨ç­‰å¾…è™šæ‹Ÿæœºåˆå§‹åŒ–..."
          else
            echo "âŒ è™šæ‹Ÿæœºåˆ›å»ºå¤±è´¥"
            echo "é”™è¯¯ç±»å‹: ${{ steps.create-vm.outputs.error_type }}"
            echo "é”™è¯¯ä¿¡æ¯: ${{ steps.create-vm.outputs.error_message }}"
            
            # å¦‚æœæ˜¯å…è´¹è´¦æˆ·é™åˆ¶ï¼Œæä¾›æ›´å¤šå»ºè®®
            if [[ "${{ steps.create-vm.outputs.free_tier_limit }}" == "true" ]]; then
              echo ""
              echo "ğŸ’¡ å…è´¹è´¦æˆ·åˆ›å»ºè™šæ‹Ÿæœºå¤±è´¥å»ºè®®:"
              echo "1. å°è¯•ä½¿ç”¨ä¸åŒçš„å¯ç”¨æ€§åŸŸ (Availability Domain)"
              echo "2. ç¨åé‡è¯•ï¼Œèµ„æºå¯èƒ½éšæ—¶é—´é‡Šæ”¾"
              echo "3. è€ƒè™‘ä½¿ç”¨ä¸åŒçš„åŒºåŸŸ (Region)"
              echo "4. æ£€æŸ¥æ‚¨çš„å…è´¹è´¦æˆ·èµ„æºä½¿ç”¨æƒ…å†µ"
              echo "5. ç¡®ä¿æ‚¨æ²¡æœ‰è¶…è¿‡å…è´¹å¥—é¤çš„é™é¢"
            fi
            
            # å¦‚æœä¸æ˜¯å…è´¹è´¦æˆ·é™åˆ¶ï¼Œå¯èƒ½æ˜¯å…¶ä»–é”™è¯¯
            if [[ "${{ steps.create-vm.outputs.error_type }}" == "network_timeout" ]]; then
              echo ""
              echo "ğŸ’¡ ç½‘ç»œè¶…æ—¶å»ºè®®:"
              echo "1. ç¨åé‡è¯•ï¼Œå¯èƒ½æ˜¯ä¸´æ—¶ç½‘ç»œé—®é¢˜"
              echo "2. æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥"
            fi
            
            # é€€å‡ºå·¥ä½œæµå¹¶æ ‡è®°ä¸ºå¤±è´¥
            exit 1
          fi

      - name: Wait for VM initialization
        if: steps.create-vm.outputs.success == 'true'
        run: |
          echo "ç­‰å¾…è™šæ‹Ÿæœºåˆå§‹åŒ–å®Œæˆ..."
          sleep 60

      - name: Get VM Public IP
        if: steps.create-vm.outputs.success == 'true'
        id: get-ip
        run: |
          PUBLIC_IP=$(oci compute instance list \
            --compartment-id "${{ secrets.OCI_COMPARTMENT_ID }}" \
            --display-name "${{ github.event.inputs.vm-name }}" \
            --lifecycle-state RUNNING \
            --query 'data[0]."public-ip"' \
            --raw-output)
          
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" == "null" ]; then
            echo "âŒ æ— æ³•è·å–è™šæ‹Ÿæœºå…¬ç½‘IP"
            echo "è¿™å¯èƒ½æ˜¯å› ä¸º:"
            echo "1. è™šæ‹Ÿæœºæ²¡æœ‰åˆ†é…å…¬ç½‘IP"
            echo "2. è™šæ‹Ÿæœºæ²¡æœ‰æˆåŠŸå¯åŠ¨"
            exit 1
          fi
          
          echo "public_ip=${PUBLIC_IP}" >> $GITHUB_OUTPUT
          echo "VM Public IP: ${PUBLIC_IP}"

      - name: Print Success Message
        if: steps.create-vm.outputs.success == 'true'
        run: |
          echo "ğŸ‰ VM instance '${{ github.event.inputs.vm-name }}' åˆ›å»ºæˆåŠŸ!"
          echo "ğŸ“Š é…ç½®: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"
          echo "ğŸ”‘ ç™»å½•ç”¨æˆ·: root"
          echo "ğŸ”’ å¯†ç : ä½¿ç”¨æ‚¨åœ¨ Secrets ä¸­è®¾ç½®çš„ ROOT_PASSWORD"
          echo "ğŸŒ è¿æ¥æ–¹å¼: ssh root@${{ steps.get-ip.outputs.public_ip }}"
          echo ""
          echo "âš ï¸  å®‰å…¨æç¤º: å¯†ç è®¤è¯å’Œ root ç™»å½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸æ¨èä½¿ç”¨"

      - name: Print Final Result
        if: always()
        run: |
          if [[ "${{ steps.create-vm.outputs.success }}" == "true" ]]; then
            echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ: è™šæ‹Ÿæœºå·²åˆ›å»ºå¹¶é…ç½®å®Œæˆ"
          else
            echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥: è™šæ‹Ÿæœºåˆ›å»ºæœªæˆåŠŸ"
            echo "è¯·æŸ¥çœ‹ä¸Šè¿°é”™è¯¯ä¿¡æ¯å’Œå»ºè®®"
          fi
