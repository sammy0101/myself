name: '[Manual] Create OCI A1 Flex VM'

on:
  workflow_dispatch:
    inputs:
      vm-name:
        description: 'Name of the VM instance'
        required: true
        default: 'a1-flex-vm'
        type: string

jobs:
  create-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OCI CLI
        uses: oracle-actions/setup-oci-cli@v1

      - name: Generate cloud-init script for root login
        run: |
          cat > cloud-init.txt << EOF
          #cloud-config
          users:
            - name: root
              password: ${{ secrets.ROOT_PASSWORD }}
              lock_passwd: false
          chpasswd:
            list: |
              root:${{ secrets.ROOT_PASSWORD }}
            expire: false
          runcmd:
            - sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
            - systemctl restart sshd
          EOF

      - name: Create A1 Flex VM Instance
        env:
          OCI_TENANCY: ${{ secrets.OCI_TENANCY }}
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_API_KEY: ${{ secrets.OCI_API_KEY }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
          OCI_SUBNET_ID: ${{ secrets.OCI_SUBNET_ID }}
        run: |
          # 创建 A1 Flex 规格的虚拟机
          oci compute instance launch \
            --compartment-id $OCI_COMPARTMENT_ID \
            --availability-domain "Pllz:PHX-AD-1" \  # 请替换为你的可用性域
            --display-name "${{ github.event.inputs.vm-name }}" \
            --shape "VM.Standard.A1.Flex" \
            --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
            --image-id "ocid1.image.oc1.ap-osaka-1.aaaaaaaaglaxxdyc7fwf77e4lq26h2nhik52d2bmxjuiqe5mzndw3zpmj4hq" \  # 请替换为ARM兼容的镜像OCID
            --subnet-id $OCI_SUBNET_ID \
            --assign-public-ip true \
            --user-data-file ./cloud-init.txt \
            --boot-volume-size-in-gbs 50  # 可选的启动卷大小（GB）

      - name: Wait for VM to initialize
        run: |
          echo "等待虚拟机初始化完成..."
          sleep 60

      - name: Get VM Public IP
        id: get-ip
        env:
          OCI_COMPARTMENT_ID: ${{ secrets.OCI_COMPARTMENT_ID }}
        run: |
          PUBLIC_IP=$(oci compute instance list \
            --compartment-id $OCI_COMPARTMENT_ID \
            --display-name "${{ github.event.inputs.vm-name }}" \
            --lifecycle-state RUNNING \
            --query 'data[0]."public-ip"' \
            --raw-output)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "VM Public IP: $PUBLIC_IP"

      - name: Print Connection Info
        run: |
          echo "🎉 VM instance '${{ github.event.inputs.vm-name }}' has been created successfully!"
          echo "📊 配置: VM.Standard.A1.Flex (4 OCPU, 24GB RAM)"
          echo "🔑 登录用户: root"
          echo "🌐 连接方式: ssh root@${{ steps.get-ip.outputs.public_ip }}"
          echo "💡 密码使用您在 Secrets 中设置的 ROOT_PASSWORD"
