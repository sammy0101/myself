name: è‡ªå‹•åŒæ­¥ byJoey/cfnew çš„ Worker

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1é»é‹è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼·åˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æª¢æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write # çµ¦äºˆ workflow å¯«å€‰åº«çš„æ¬Šé™

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºæ‚¨çš„å€‰åº«
        uses: actions/checkout@v4

      - name: æª¢æŸ¥ä¸¦åŒæ­¥æœ€æ–° Worker
        env:
          # æˆ‘å€‘ä¸å†éœ€è¦ GITHUB_TOKENï¼Œå› ç‚º Cloudflare API æ˜¯å…¬é–‹çš„
          REPO_API_URL: https://api.github.com/repos/byJoey/cfnew/tags
          TARGET_FILE: _worker.js
        run: |
          # æ—¥èªŒå‡½æ•¸
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          log "é–‹å§‹æª¢æŸ¥ byJoey/cfnew æ›´æ–°..."

          # ç²å–æœ¬åœ°è¨˜éŒ„çš„ç‰ˆæœ¬è™Ÿ
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "0.0.0")
          log "æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"

          # ç²å–æœ€æ–°çš„ Tag è³‡è¨Š
          log "ç²å–æœ€æ–° Tag..."
          # é€™è£¡æˆ‘å€‘æ”¹ç”¨ tags APIï¼Œå› ç‚ºä½œè€…æ²’æœ‰å»ºç«‹ Releases
          LATEST_TAG=$(curl -s "$REPO_API_URL" | jq -r '.[0].name')

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            log "ERROR: ç„¡æ³•å¾ byJoey/cfnew ç²å–æœ€æ–°ç‰ˆæœ¬è™Ÿ"
            exit 1
          fi
          log "æœ€æ–°ç‰ˆæœ¬: $LATEST_TAG"

          # åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          if [ "$LOCAL_VERSION" == "$LATEST_TAG" ] && [ "$FORCE_UPDATE" != "true" ]; then
            log "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œç„¡éœ€åŒæ­¥"
            # ç‚ºäº†è®“å¾ŒçºŒæ­¥é©ŸçŸ¥é“æˆ‘å€‘æ²’æœ‰æ›´æ–°ï¼Œå»ºç«‹ä¸€å€‹è¼¸å‡º
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # çµ„åˆä¸‹è¼‰é€£çµ
          DOWNLOAD_URL="https://github.com/byJoey/cfnew/releases/download/${LATEST_TAG}/${TARGET_FILE}"

          log "ç™¼ç¾æ–°ç‰ˆæœ¬ï¼Œé–‹å§‹ä¸‹è¼‰ $DOWNLOAD_URL..."
          curl -L -o "$TARGET_FILE" "$DOWNLOAD_URL"
          if [ $? -ne 0 ]; then
            log "ERROR: ä¸‹è¼‰ $TARGET_FILE å¤±æ•—"
            exit 1
          fi

          log "æ›´æ–°æœ¬åœ° version.txt æª”æ¡ˆ..."
          echo "$LATEST_TAG" > version.txt
          
          # å»ºç«‹è¼¸å‡ºï¼Œæ–¹ä¾¿ commit message ä½¿ç”¨
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "tag_name=$LATEST_TAG" >> $GITHUB_OUTPUT
          log "åŒæ­¥å®Œæˆï¼Œæ–°ç‰ˆæœ¬ç‚º: $LATEST_TAG"
        id: check_update # çµ¦é€™å€‹æ­¥é©Ÿä¸€å€‹IDï¼Œæ–¹ä¾¿å¾ŒçºŒå¼•ç”¨

      - name: æäº¤æ›´æ–°åˆ°æ‚¨çš„å€‰åº«
        # åªæœ‰åœ¨ check_update æ­¥é©Ÿçš„è¼¸å‡º updated ç‚º true æ™‚æ‰åŸ·è¡Œ
        if: steps.check_update.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªå‹•åŒæ­¥ Worker ç‰ˆæœ¬: ${{ steps.check_update.outputs.tag_name }}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
