name: Deploy Intensively Obfuscated Cloudflare Worker

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Download, Obfuscate, and Deploy
    steps:
      - name: Get latest version tag
        id: get_version
        run: |
          LATEST_TAG=$(curl --silent "https://api.github.com/repos/byJoey/cfnew/tags" | jq -r '.[0].name')
          echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT

      - name: Download latest Worker script
        run: |
          echo "Downloading version ${{ steps.get_version.outputs.tag }}"
          curl -L -o _worker.js "https://github.com/byJoey/cfnew/releases/download/${{ steps.get_version.outputs.tag }}/_worker.js"

      # --- 核心步驟：使用 javascript-obfuscator 進行強力混淆 ---
      - name: Intensively Obfuscate Script
        run: |
          echo "Installing javascript-obfuscator..."
          # 安裝混淆工具
          npm install javascript-obfuscator -g
          
          echo "Obfuscating the script..."
          # 執行混淆，並將結果輸出到新檔案 _worker.obfuscated.js
          # 即使 Cloudflare 美化了這個檔案，它依然是高度混淆、難以閱讀的
          javascript-obfuscator _worker.js --output _worker.obfuscated.js --compact true --control-flow-flattening true --dead-code-injection false --string-array true --string-array-encoding 'base64' --unicode-escape-sequence false

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          # 注意：我們部署的是經過二次強力混淆後的 _worker.obfuscated.js 檔案
          command: deploy _worker.obfuscated.js --name newnew --compatibility-date 2025-11-04
