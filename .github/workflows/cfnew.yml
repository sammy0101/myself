name: è‡ªå‹•åŒæ­¥ byJoey/cfnew

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1é»é‹è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼·åˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æª¢æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write # çµ¦äºˆ workflow å¯«å€‰åº«çš„æ¬Šé™

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºæ‚¨çš„å€‰åº«
        uses: actions/checkout@v4

      - name: æª¢æŸ¥ä¸¦åŒæ­¥æœ€æ–° Worker
        env:
          # --- æ ¸å¿ƒä¿®æ”¹é»: æ”¹ç”¨ releases API ---
          REPO_API_URL: https://api.github.com/repos/byJoey/cfnew/releases
        run: |
          # æ—¥èªŒå‡½æ•¸
          log() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"; }

          log "é–‹å§‹æª¢æŸ¥ byJoey/cfnew æ›´æ–°..."

          # ç²å–æœ¬åœ°è¨˜éŒ„çš„ç‰ˆæœ¬è™Ÿ
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "0.0.0")
          log "æœ¬åœ°ç‰ˆæœ¬: $LOCAL_VERSION"

          # ç²å–æœ€æ–°çš„ Release å®Œæ•´è³‡è¨Š
          log "ç²å–æœ€æ–° Release è³‡è¨Š..."
          LATEST_RELEASE_INFO=$(curl -s "$REPO_API_URL" | jq '.[0]')
          LATEST_TAG=$(echo "$LATEST_RELEASE_INFO" | jq -r '.tag_name')

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            log "ERROR: ç„¡æ³•å¾ byJoey/cfnew ç²å–æœ€æ–°ç‰ˆæœ¬è³‡è¨Š"
            exit 1
          fi
          log "æœ€æ–°ç‰ˆæœ¬: $LATEST_TAG"

          # åˆ¤æ–·æ˜¯å¦éœ€è¦æ›´æ–°
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          if [ "$LOCAL_VERSION" == "$LATEST_TAG" ] && [ "$FORCE_UPDATE" != "true" ]; then
            log "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œç„¡éœ€åŒæ­¥"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # --- æ ¸å¿ƒä¿®æ”¹é»: å‹•æ…‹ç™¼ç¾ç›®æ¨™ ZIP æª”æ¡ˆ ---
          log "å‹•æ…‹ç™¼ç¾ç›®æ¨™ ZIP æª”æ¡ˆ..."
          # ç¯©é¸å‡ºé™„ä»¶ä¸­ï¼Œçµå°¾æ˜¯ .zip ä¸”åç¨±ä¸æ˜¯ "Source code" é–‹é ­çš„æª”æ¡ˆ
          TARGET_ASSET_INFO=$(echo "$LATEST_RELEASE_INFO" | jq '.assets[] | select(.name | endswith(".zip") and (startswith("Source code") | not))')
          
          # å¾ç¯©é¸å‡ºçš„è³‡è¨Šä¸­ï¼Œæå–æª”æ¡ˆåç¨±å’Œä¸‹è¼‰é€£çµ
          TARGET_FILE=$(echo "$TARGET_ASSET_INFO" | jq -r '.name')
          DOWNLOAD_URL=$(echo "$TARGET_ASSET_INFO" | jq -r '.browser_download_url')

          if [ -z "$TARGET_FILE" ] || [ "$TARGET_FILE" == "null" ]; then
            log "ERROR: åœ¨ç‰ˆæœ¬ $LATEST_TAG ä¸­æœªæ‰¾åˆ°ç›®æ¨™ ZIP æª”æ¡ˆï¼"
            exit 1
          fi
          log "æˆåŠŸç™¼ç¾ç›®æ¨™æª”æ¡ˆ: $TARGET_FILE"
          log "ä¸‹è¼‰é€£çµ: $DOWNLOAD_URL"

          log "ç™¼ç¾æ–°ç‰ˆæœ¬ï¼Œé–‹å§‹ä¸‹è¼‰..."
          wget -q -O "$TARGET_FILE" "$DOWNLOAD_URL"
          if [ $? -ne 0 ]; then
            log "ERROR: ä¸‹è¼‰ $TARGET_FILE å¤±æ•—"
            exit 1
          fi

          log "è§£å£“ç¸® $TARGET_FILE..."
          unzip -o "$TARGET_FILE"

          log "æ¸…ç†å·²ä¸‹è¼‰çš„ ZIP æª”æ¡ˆ..."
          rm "$TARGET_FILE"

          log "æ›´æ–°æœ¬åœ° version.txt æª”æ¡ˆ..."
          echo "$LATEST_TAG" > version.txt
          
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "tag_name=$LATEST_TAG" >> $GITHUB_OUTPUT
          log "åŒæ­¥å®Œæˆï¼Œæ–°ç‰ˆæœ¬ç‚º: $LATEST_TAG"
        id: check_update

      - name: æäº¤æ›´æ–°åˆ°æ‚¨çš„å€‰åº«
        if: steps.check_update.outputs.updated == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªå‹•åŒæ­¥ Worker ç‰ˆæœ¬: ${{ steps.check_update.outputs.tag_name }}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
