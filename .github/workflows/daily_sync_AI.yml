name: Daily Sync AI Rules

on:
  schedule:
    # 每天 UTC 20:00 (香港時間 04:00) 執行
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  update_rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz PyYAML

      # ----------------------------------------------------------------
      # 1. 執行 Python 腳本
      # ----------------------------------------------------------------
      - name: 執行 Python 更新腳本
        run: |
          echo "Step 1: Running geosite_ai_hk.py..."
          python geosite_ai_hk.py
          
          echo "Step 2: Running Shadowrocket_rules.py..."
          python Shadowrocket_rules.py

      # ----------------------------------------------------------------
      # 2. 檢查是否有變更 (關鍵步驟)
      # ----------------------------------------------------------------
      - name: 檢查規則是否有變動
        id: check_changes
        run: |
          # 使用 git status 檢查是否有檔案被修改
          if [ -n "$(git status --porcelain)" ]; then
            echo "偵測到檔案變更，準備進行編譯..."
            echo "rules_changed=true" >> $GITHUB_OUTPUT
          else
            echo "所有規則均未變更，跳過後續步驟。"
            echo "rules_changed=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------------------
      # 3. 下載編譯工具 (只有在 rules_changed 為 true 時執行)
      # ----------------------------------------------------------------
      - name: 下載最新版編譯工具
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          echo "正在抓取最新版本資訊..."
          # Mihomo
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep "browser_download_url" | grep "linux-amd64" | grep ".gz" | grep -v "compatible" | head -n 1 | cut -d '"' -f 4)
          wget -O mihomo.gz "$MIHOMO_URL" && gunzip mihomo.gz && chmod +x mihomo
          
          # Sing-box
          SINGBOX_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep "browser_download_url" | grep "linux-amd64.tar.gz" | head -n 1 | cut -d '"' -f 4)
          wget -O sing-box.tar.gz "$SINGBOX_URL" && tar -xzf sing-box.tar.gz && mv sing-box-*/sing-box . && chmod +x sing-box

      # ----------------------------------------------------------------
      # 4. 編譯 MRS (只有在 rules_changed 為 true 時執行)
      # ----------------------------------------------------------------
      - name: 編譯 MRS 規則
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          echo "Compiling MRS..."
          if [ -f "geosite_ai_hk_proxy.list" ]; then
            touch config.yaml
            timeout 60s ./mihomo convert-ruleset domain text geosite_ai_hk_proxy.list geosite_ai_hk_proxy.mrs
            rm config.yaml
            echo "MRS compiled."
          fi

      # ----------------------------------------------------------------
      # 5. 編譯 SRS (只有在 rules_changed 為 true 時執行)
      # ----------------------------------------------------------------
      - name: 編譯 SRS 規則
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          echo "Compiling SRS..."
          # 使用 Python 腳本生成的 json 直接編譯
          if [ -f "geosite_ai_hk_proxy.json" ]; then
             ./sing-box rule-set compile --output geosite_ai_hk_proxy.srs geosite_ai_hk_proxy.json
             echo "SRS compiled."
          else
             echo "JSON not found, skipping SRS."
          fi

      - name: 清理工具
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: rm -rf mihomo sing-box sing-box.tar.gz sing-box-* config.yaml

      # ----------------------------------------------------------------
      # 6. 提交變更 (只有在 rules_changed 為 true 時執行)
      # ----------------------------------------------------------------
      - name: 提交變更 (Commit & Push)
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Auto sync: $(TZ=Asia/Hong_Kong date +'%Y-%m-%d %H:%M')"
          git push
