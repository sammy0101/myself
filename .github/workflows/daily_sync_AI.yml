name: Daily Sync AI Rules

on:
  schedule:
    # 每天 UTC 20:00 (香港時間 04:00) 執行
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  update_rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # 這裡新增了 PyYAML 解決報錯
          pip install requests pytz PyYAML

      - name: 執行 Python 腳本更新清單
        run: python geosite_ai_hk.py
        # 這一步會產生新的 geosite_ai_hk_proxy.list

      # ----------------------------------------------------------------
      # 下載工具並編譯 MRS 與 SRS
      # ----------------------------------------------------------------
      - name: 下載編譯工具 (Mihomo & Sing-box)
        run: |
          # 下載 Mihomo (用於編譯 MRS)
          wget -O mihomo.gz https://github.com/MetaCubeX/mihomo/releases/download/v1.18.1/mihomo-linux-amd64-v1.18.1.gz
          gunzip mihomo.gz
          chmod +x mihomo

          # 下載 Sing-box (用於編譯 SRS)
          wget -O sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v1.10.1/sing-box-1.10.1-linux-amd64.tar.gz
          tar -xzf sing-box.tar.gz
          mv sing-box-*/sing-box .
          chmod +x sing-box

      - name: 編譯 MRS 規則
        run: |
          # 將 .list (純域名) 編譯成 .mrs
          echo "Compiling MRS..."
          # 確保檔案存在再執行
          if [ -f "geosite_ai_hk_proxy.list" ]; then
            ./mihomo convert-ruleset domain text geosite_ai_hk_proxy.list geosite_ai_hk_proxy.mrs
          else
            echo "Error: geosite_ai_hk_proxy.list not found!"
            exit 1
          fi

      - name: 編譯 SRS 規則
        run: |
          echo "Compiling SRS..."
          # 1. 建立臨時 JSON (Sing-box 編譯必須要 JSON 格式來源)
          python -c "
          import json
          import os
          if os.path.exists('geosite_ai_hk_proxy.list'):
              try:
                  with open('geosite_ai_hk_proxy.list', 'r') as f:
                      # 讀取非註解的行
                      domains = [line.strip() for line in f if line.strip() and not line.startswith('#')]
                  
                  # 構建 Sing-box Rule-set 格式
                  data = {'version': 1, 'rules': [{'domain': domains}]}
                  
                  with open('geosite_ai_hk_proxy_temp.json', 'w') as f:
                      json.dump(data, f, indent=2)
                  print('Temporary JSON created.')
              except Exception as e:
                  print(f'Error converting to JSON: {e}')
                  exit(1)
          else:
              print('List file not found for SRS compilation.')
          "

          # 2. 將臨時 JSON 編譯成 .srs
          if [ -f "geosite_ai_hk_proxy_temp.json" ]; then
            ./sing-box rule-set compile --output geosite_ai_hk_proxy.srs geosite_ai_hk_proxy_temp.json
            rm geosite_ai_hk_proxy_temp.json
          fi

      - name: 清理工具
        run: |
          rm -rf mihomo sing-box sing-box.tar.gz sing-box-*
      # ----------------------------------------------------------------

      - name: 提交變更 (Commit & Push)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 加入所有變更
          git add .
          
          # 檢查是否有變更，有則提交並加上香港時間
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto sync: $(TZ=Asia/Hong_Kong date +'%Y-%m-%d %H:%M')" && git push)
