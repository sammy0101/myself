name: Daily Sync AI Rules

on:
  schedule:
    # æ¯å¤© UTC 20:00 (é¦™æ¸¯æ™‚é–“ 04:00) åŸ·è¡Œ
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  update_rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz PyYAML

      # ----------------------------------------------------------------
      # 1. åŸ·è¡Œ Python è…³æœ¬
      # ----------------------------------------------------------------
      - name: åŸ·è¡Œ Python æ›´æ–°è…³æœ¬
        run: |
          echo "Step 1: Running geosite_ai_hk.py..."
          python geosite_ai_hk.py
          
          echo "Step 2: Running Shadowrocket_rules.py..."
          python Shadowrocket_rules.py

      # ----------------------------------------------------------------
      # 2. æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´ (æ™ºæ…§æ¯”å°)
      # ----------------------------------------------------------------
      - name: æª¢æŸ¥è¦å‰‡æ˜¯å¦æœ‰è®Šå‹•
        id: check_changes
        run: |
          # ä½¿ç”¨ git status æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè¢«ä¿®æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            echo "åµæ¸¬åˆ°æª”æ¡ˆè®Šæ›´ï¼Œæº–å‚™é€²è¡Œç·¨è­¯..."
            echo "rules_changed=true" >> $GITHUB_OUTPUT
          else
            echo "æ‰€æœ‰è¦å‰‡å‡æœªè®Šæ›´ï¼Œè·³éå¾ŒçºŒæ­¥é©Ÿã€‚"
            echo "rules_changed=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------------------
      # 3. ä¸‹è¼‰ç·¨è­¯å·¥å…· (åªæœ‰åœ¨ rules_changed ç‚º true æ™‚åŸ·è¡Œ)
      # ----------------------------------------------------------------
      - name: ä¸‹è¼‰æœ€æ–°ç‰ˆç·¨è­¯å·¥å…·
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          echo "æ­£åœ¨æŠ“å–æœ€æ–°ç‰ˆæœ¬è³‡è¨Š..."
          # Mihomo
          MIHOMO_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep "browser_download_url" | grep "linux-amd64" | grep ".gz" | grep -v "compatible" | head -n 1 | cut -d '"' -f 4)
          wget -O mihomo.gz "$MIHOMO_URL" && gunzip mihomo.gz && chmod +x mihomo
          
          # Sing-box
          SINGBOX_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep "browser_download_url" | grep "linux-amd64.tar.gz" | head -n 1 | cut -d '"' -f 4)
          wget -O sing-box.tar.gz "$SINGBOX_URL" && tar -xzf sing-box.tar.gz && mv sing-box-*/sing-box . && chmod +x sing-box

      # ----------------------------------------------------------------
      # 4. ç·¨è­¯ MRS (åªæœ‰åœ¨ rules_changed ç‚º true æ™‚åŸ·è¡Œ)
      # ----------------------------------------------------------------
      - name: ç·¨è­¯ MRS è¦å‰‡
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          echo "Compiling MRS..."
          if [ -f "geosite_ai_hk_proxy.list" ]; then
            touch config.yaml
            timeout 60s ./mihomo convert-ruleset domain text geosite_ai_hk_proxy.list geosite_ai_hk_proxy.mrs
            rm config.yaml
            echo "MRS compiled."
          fi

      # ----------------------------------------------------------------
      # 5. ç·¨è­¯ SRS (åªæœ‰åœ¨ rules_changed ç‚º true æ™‚åŸ·è¡Œ)
      # ----------------------------------------------------------------
      - name: ç·¨è­¯ SRS è¦å‰‡
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          echo "Compiling SRS..."
          if [ -f "geosite_ai_hk_proxy.json" ]; then
             ./sing-box rule-set compile --output geosite_ai_hk_proxy.srs geosite_ai_hk_proxy.json
             echo "SRS compiled."
          else
             echo "JSON not found, skipping SRS."
          fi

      - name: æ¸…ç†å·¥å…·
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: rm -rf mihomo sing-box sing-box.tar.gz sing-box-* config.yaml

      # ----------------------------------------------------------------
      # 6. æäº¤è®Šæ›´ (ä¿®æ”¹äº†æäº¤è¨Šæ¯æ ¼å¼)
      # ----------------------------------------------------------------
      - name: æäº¤è®Šæ›´ (Commit & Push)
        if: steps.check_changes.outputs.rules_changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          
          # ä¿®æ”¹é€™è£¡ï¼šä½¿ç”¨ä½ æŒ‡å®šçš„æ ¼å¼
          # æ ¼å¼ç¯„ä¾‹ï¼šğŸ”„ è‡ªå‹•åŒæ­¥ AI è¦å‰‡ (ğŸ“… 2025-12-10 19:02)
          git commit -m "ğŸ”„ è‡ªå‹•åŒæ­¥ AI è¦å‰‡ (ğŸ“… $(TZ=Asia/Hong_Kong date +'%Y-%m-%d %H:%M'))"
          
          git push
